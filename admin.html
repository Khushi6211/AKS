<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Arun Karyana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: transform 0.3s ease;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
            }
            /* Make stat cards stack on mobile */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            /* Make tables scrollable on mobile */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            /* Larger touch targets */
            .nav-item {
                padding: 1rem 1.5rem !important;
                font-size: 1rem !important;
            }
            button {
                min-height: 44px;
            }
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 10px;
                max-height: 95vh;
            }
        }
        
        /* Overlay for mobile menu */
        .mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .mobile-overlay.active {
            display: block;
        }
        
        /* Hamburger menu */
        .hamburger {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 60;
            background: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }
            /* Improve form inputs on mobile */
            input, textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
            /* Stack header elements */
            .header-actions {
                flex-direction: column;
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .stat-card-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dropzone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dropzone:hover, .dropzone.drag-over {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-out-for-delivery { background-color: #e0e7ff; color: #3730a3; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        
        /* Custom Scrollbar for Sidebar */
        nav::-webkit-scrollbar {
            width: 6px;
        }
        nav::-webkit-scrollbar-track {
            background: #1F2937;
        }
        nav::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 3px;
        }
        nav::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Mobile Hamburger Menu -->
    <button id="hamburger-btn" class="hamburger">
        <i class="fas fa-bars text-gray-700 text-xl"></i>
    </button>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="mobile-overlay"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-screen w-64 bg-gray-900 text-white z-50 shadow-xl flex flex-col">
        <!-- Sidebar Header (Fixed) -->
        <div class="p-6 border-b border-gray-700 relative flex-shrink-0">
            <button id="close-sidebar" class="absolute top-4 right-4 text-gray-400 hover:text-white md:hidden">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h1 class="text-2xl font-bold text-white mb-1">Arun Karyana</h1>
            <p class="text-gray-400 text-sm">Admin Dashboard</p>
        </div>
        
        <!-- Scrollable Navigation Area -->
        <nav class="flex-1 overflow-y-auto mt-6" style="scrollbar-width: thin; scrollbar-color: #4B5563 #1F2937;">
            <a href="#" data-section="dashboard" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition active">
                <i class="fas fa-chart-line w-6"></i>
                <span class="ml-3">Dashboard</span>
            </a>
            <a href="#" data-section="orders" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-shopping-bag w-6"></i>
                <span class="ml-3">Orders</span>
            </a>
            <a href="#" data-section="products" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-box w-6"></i>
                <span class="ml-3">Products</span>
            </a>
            <a href="#" data-section="categories" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-th-large w-6"></i>
                <span class="ml-3">Categories</span>
            </a>
            <a href="#" data-section="offers" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-tag w-6"></i>
                <span class="ml-3">Offers</span>
            </a>
            <a href="#" data-section="banners" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-bullhorn w-6"></i>
                <span class="ml-3">Offer Banners</span>
            </a>
            <a href="#" data-section="popups" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-bell w-6"></i>
                <span class="ml-3">Welcome Popups</span>
            </a>
            <a href="#" data-section="customers" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-users w-6"></i>
                <span class="ml-3">Customers</span>
            </a>
            <a href="#" data-section="reviews" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-star w-6"></i>
                <span class="ml-3">Reviews</span>
            </a>
            <a href="#" data-section="messages" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-envelope w-6"></i>
                <span class="ml-3">Messages</span>
            </a>
        </nav>
        
        <!-- Sidebar Footer (Fixed) -->
        <div class="w-full p-6 border-t border-gray-700 flex-shrink-0 bg-gray-900">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium" id="admin-name">Admin</p>
                    <p class="text-xs text-gray-400">Administrator</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content ml-0 md:ml-64 p-4 md:p-8 pt-16 md:pt-8">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
            <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800" id="section-title">Dashboard</h2>
                <p class="text-sm sm:text-base text-gray-600 mt-1" id="section-subtitle">Welcome back! Here's what's happening today.</p>
            </div>
            <button onclick="location.href='index.html'" class="w-full sm:w-auto px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                <i class="fas fa-store mr-2"></i>View Store
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <!-- Stats Cards -->
            <div class="stats-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Today's Sales</p>
                            <h3 class="text-3xl font-bold mt-2">‚Çπ<span id="stat-sales">0</span></h3>
                            <p class="text-xs mt-2 opacity-70"><span id="stat-orders-today">0</span> orders</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-rupee-sign text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-2 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Pending Orders</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-pending">0</span></h3>
                            <p class="text-xs mt-2 opacity-70">Need attention</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-3 rounded-xl shadow-lg p-6 text-white cursor-pointer hover:shadow-2xl transition" onclick="navigateToLowStock()">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Total Products</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-products">0</span></h3>
                            <button id="low-stock-badge" class="mt-2 px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full hover:bg-red-600 transition" onclick="event.stopPropagation(); navigateToLowStock();">
                                <i class="fas fa-exclamation-triangle mr-1"></i><span id="stat-low-stock">0</span> LOW STOCK
                            </button>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-box text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-4 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Total Customers</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-customers">0</span></h3>
                            <p class="text-xs mt-2 opacity-70">Registered users</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Orders</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Order ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Customer</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Amount</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Status</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-tbody">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">All Orders</h3>
                    <div class="flex gap-2">
                        <select id="order-status-filter" class="px-4 py-2 border rounded-lg">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <input type="text" id="order-search" placeholder="Search by customer..." class="px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Order ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Customer</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Phone</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Amount</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Status</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Date</th>
                                <th class="text-center py-3 px-4 text-gray-600 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Products Management</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="showBulkUploadModal()" class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition whitespace-nowrap">
                            <i class="fas fa-file-excel mr-2"></i><span class="hidden sm:inline">Bulk Upload</span>
                        </button>
                        <button onclick="showAddProductModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i><span class="hidden sm:inline">Add </span>Product
                        </button>
                    </div>
                </div>                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <button id="filter-all-products" onclick="filterProducts('all')" class="px-4 py-3 bg-purple-600 text-white rounded-lg transition hover:bg-purple-700 text-sm sm:text-base">
                        <i class="fas fa-th mr-2"></i>All Products
                    </button>
                    <button id="filter-low-stock" onclick="filterProducts('low-stock')" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg transition hover:bg-red-100 hover:text-red-700 text-sm sm:text-base">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Low Stock Only
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="products-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Category Management</h3>
                    <button onclick="showAddCategoryModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Add Category
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categories-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Offers Section -->
        <div id="offers-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Offers & Promotions</h3>
                    <button onclick="showAddOfferModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Add Offer
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="offers-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Banners Section -->
        <div id="banners-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Running Offer Banners</h3>
                    <button onclick="showAddBannerModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Add Banner
                    </button>
                </div>
                <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-700 text-sm rounded space-y-2">
                    <div>
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>How Banner Display Works:</strong>
                    </div>
                    <ul class="ml-6 list-disc space-y-1">
                        <li><strong>Active Banner:</strong> Only ONE banner can be active at a time. The active banner is displayed prominently on the homepage with animated scrolling text.</li>
                        <li><strong>Set as Active:</strong> Click the "Activate" button to make a banner live. This will automatically deactivate any previously active banner.</li>
                        <li><strong>Multiple Banners:</strong> You can create and save multiple banners, but only the active one will be visible to customers.</li>
                        <li><strong>Visual Effect:</strong> Active banners appear with LED-style glowing text, gradient background, and smooth scrolling animation on the homepage.</li>
                        <li><strong>Testing:</strong> After activating a banner, visit your homepage to see it in action!</li>
                    </ul>
                </div>
                <div class="grid grid-cols-1 gap-4" id="banners-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Welcome Popups Section -->
        <div id="popups-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Welcome Popups / Announcements</h3>
                    <button onclick="showAddPopupModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i>Create Popup
                    </button>
                </div>
                <div class="mb-4 p-4 bg-green-50 border-l-4 border-green-500 text-green-700 text-sm rounded space-y-2">
                    <div>
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Welcome Popup System:</strong>
                    </div>
                    <ul class="ml-6 list-disc space-y-1">
                        <li><strong>Purpose:</strong> Show important announcements, new arrivals, discounts, or promotions when users first visit your website.</li>
                        <li><strong>Poster Image:</strong> Upload an eye-catching image/poster to grab attention.</li>
                        <li><strong>Link Options:</strong> Link to a specific product, category, external URL, or no link at all.</li>
                        <li><strong>Display Frequency:</strong> Control how often the popup shows - always, once per session, or once per day.</li>
                        <li><strong>Active Status:</strong> Only ONE popup can be active at a time. Activate to show it on the homepage.</li>
                    </ul>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="popups-grid">
                    <div class="text-center py-8 text-gray-400 col-span-full">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Customer Management</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Name</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Email</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Phone</th>
                                <th class="text-center py-3 px-4 text-gray-600 font-medium">Orders</th>
                                <th class="text-right py-3 px-4 text-gray-600 font-medium">Total Spent</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Joined</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Customer Reviews</h3>
                    <div class="flex gap-2">
                        <button onclick="filterReviews('all')" class="review-filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition active" data-filter="all">
                            All Reviews
                        </button>
                        <button onclick="filterReviews('featured')" class="review-filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-filter="featured">
                            <i class="fas fa-star text-yellow-500 mr-1"></i>Featured
                        </button>
                        <button onclick="filterReviews('5')" class="review-filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-filter="5">
                            5‚òÖ
                        </button>
                        <button onclick="filterReviews('4')" class="review-filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition" data-filter="4">
                            4‚òÖ
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="reviews-grid">
                    <div class="text-center py-8 text-gray-400 col-span-full">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div id="messages-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-4 md:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800">Contact Form Messages</h3>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <button onclick="filterMessages('all')" class="message-filter-btn px-3 md:px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition active text-sm md:text-base flex-1 sm:flex-none" data-filter="all">
                            All Messages
                        </button>
                        <button onclick="filterMessages('unread')" class="message-filter-btn px-3 md:px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition text-sm md:text-base flex-1 sm:flex-none" data-filter="unread">
                            <i class="fas fa-envelope text-red-500 mr-1"></i>Unread
                        </button>
                        <button onclick="filterMessages('read')" class="message-filter-btn px-3 md:px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition text-sm md:text-base flex-1 sm:flex-none" data-filter="read">
                            <i class="fas fa-envelope-open text-green-500 mr-1"></i>Read
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4" id="messages-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Order Details</h3>
                <button onclick="closeModal('order-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="product-modal-title">Add Product</h3>
                <button onclick="closeModal('product-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                <input type="hidden" id="cloudinary-public-id">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Primary Product Image</label>
                    <div id="image-dropzone" class="dropzone" onclick="document.getElementById('image-input').click()">
                        <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                        <div id="dropzone-content">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-400 mt-1">PNG, JPG, WEBP (max. 5MB)</p>
                        </div>
                        <div id="image-preview" class="hidden">
                            <img id="preview-img" class="max-w-full h-auto rounded-lg">
                            <button type="button" onclick="removeImage(event)" class="mt-2 text-red-600 hover:text-red-700">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">
                        Additional Images (Optional)
                        <span class="text-sm text-gray-500">- Images will cycle on hover</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                        <input type="file" id="additional-images-input" accept="image/*" multiple class="hidden" onchange="handleAdditionalImagesSelect(event)">
                        <button type="button" onclick="document.getElementById('additional-images-input').click()" class="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                            <i class="fas fa-plus-circle mr-2"></i>Add More Images (Max 5)
                        </button>
                        <div id="additional-images-preview" class="grid grid-cols-4 gap-2 mt-3"></div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Product Name</label>
                    <input type="text" id="product-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Price (‚Çπ)</label>
                        <input type="number" id="product-price" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Stock</label>
                        <input type="number" id="product-stock" required min="0" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Category</label>
                    <select id="product-category" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">Select Category</option>
                        <!-- Categories will be dynamically loaded -->
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Description (Optional)</label>
                    <textarea id="product-description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                        <i class="fas fa-save mr-2"></i>Save Product
                    </button>
                    <button type="button" onclick="closeModal('product-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Banner Modal -->
    <div id="banner-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="banner-modal-title">Add Banner</h3>
                <button onclick="closeModal('banner-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="banner-form" onsubmit="saveBanner(event)">
                <input type="hidden" id="banner-id">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Banner Text *</label>
                    <textarea id="banner-text" required rows="3" placeholder="e.g., Special 50% OFF on all grocery items! Shop now!" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"></textarea>
                    
                    <!-- Emoji & Icon Picker -->
                    <div class="mt-2 flex gap-2 flex-wrap">
                        <button type="button" onclick="toggleEmojiPicker()" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-sm">
                            <i class="far fa-smile"></i> Add Emoji
                        </button>
                        <button type="button" onclick="insertText('üî•')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üî•</button>
                        <button type="button" onclick="insertText('‚≠ê')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">‚≠ê</button>
                        <button type="button" onclick="insertText('üí•')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üí•</button>
                        <button type="button" onclick="insertText('üéâ')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üéâ</button>
                        <button type="button" onclick="insertText('üéä')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üéä</button>
                        <button type="button" onclick="insertText('üõí')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üõí</button>
                        <button type="button" onclick="insertText('üí∞')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üí∞</button>
                        <button type="button" onclick="insertText('üéÅ')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üéÅ</button>
                        <button type="button" onclick="insertText('üëâ')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">üëâ</button>
                        <button type="button" onclick="insertText('‚ú®')" class="px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">‚ú®</button>
                    </div>
                    
                    <!-- Extended Emoji Picker (hidden by default) -->
                    <div id="emoji-picker" class="hidden mt-2 p-3 bg-gray-50 border rounded-lg">
                        <div class="grid grid-cols-10 gap-2">
                            <button type="button" onclick="insertText('üòÄ')" class="px-2 py-1 hover:bg-gray-200 rounded">üòÄ</button>
                            <button type="button" onclick="insertText('üòÉ')" class="px-2 py-1 hover:bg-gray-200 rounded">üòÉ</button>
                            <button type="button" onclick="insertText('üòÑ')" class="px-2 py-1 hover:bg-gray-200 rounded">üòÑ</button>
                            <button type="button" onclick="insertText('üòç')" class="px-2 py-1 hover:bg-gray-200 rounded">üòç</button>
                            <button type="button" onclick="insertText('ü•≥')" class="px-2 py-1 hover:bg-gray-200 rounded">ü•≥</button>
                            <button type="button" onclick="insertText('ü§©')" class="px-2 py-1 hover:bg-gray-200 rounded">ü§©</button>
                            <button type="button" onclick="insertText('üíØ')" class="px-2 py-1 hover:bg-gray-200 rounded">üíØ</button>
                            <button type="button" onclick="insertText('üîî')" class="px-2 py-1 hover:bg-gray-200 rounded">üîî</button>
                            <button type="button" onclick="insertText('üíµ')" class="px-2 py-1 hover:bg-gray-200 rounded">üíµ</button>
                            <button type="button" onclick="insertText('üè™')" class="px-2 py-1 hover:bg-gray-200 rounded">üè™</button>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-2">üí° Tip: Use emojis to make your banner more eye-catching!</p>
                </div>
                
                <!-- Multiple Announcements Section -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">
                        Multiple Announcements (Optional)
                        <span class="text-sm text-gray-500">- Will rotate automatically</span>
                    </label>
                    <div id="additional-announcements" class="space-y-2">
                        <!-- Additional announcement fields will be added here -->
                    </div>
                    <button type="button" onclick="addAnnouncementField()" class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm">
                        <i class="fas fa-plus-circle mr-1"></i>Add Another Announcement
                    </button>
                    <p class="text-sm text-gray-500 mt-1">Add multiple messages that will rotate in the same banner (5 seconds each)</p>
                </div>

                <!-- Gradient Toggle -->
                <div class="mb-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="banner-gradient-enabled" class="mr-2 w-4 h-4" onchange="toggleGradientOptions()">
                        <span class="text-gray-700 font-medium">Use Gradient Background</span>
                    </label>
                </div>
                
                <!-- Solid Color (shown when gradient is off) -->
                <div id="solid-color-options" class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Background Color</label>
                        <input type="color" id="banner-bg-color" value="#FF6B6B" class="w-full h-10 rounded border cursor-pointer">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Text Color</label>
                        <input type="color" id="banner-text-color" value="#FFFFFF" class="w-full h-10 rounded border cursor-pointer">
                    </div>
                </div>
                
                <!-- Gradient Options (shown when gradient is on) -->
                <div id="gradient-options" class="hidden mb-4">
                    <div class="grid grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Gradient Start</label>
                            <input type="color" id="banner-gradient-start" value="#667eea" class="w-full h-10 rounded border cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Gradient End</label>
                            <input type="color" id="banner-gradient-end" value="#764ba2" class="w-full h-10 rounded border cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Text Color</label>
                            <input type="color" id="banner-gradient-text-color" value="#FFFFFF" class="w-full h-10 rounded border cursor-pointer">
                        </div>
                    </div>
                    <!-- Preset Gradients -->
                    <div class="mb-2">
                        <label class="block text-gray-700 font-medium mb-2">Preset Gradients</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="applyGradientPreset('#667eea', '#764ba2')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #667eea, #764ba2)"></button>
                            <button type="button" onclick="applyGradientPreset('#f093fb', '#f5576c')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #f093fb, #f5576c)"></button>
                            <button type="button" onclick="applyGradientPreset('#4facfe', '#00f2fe')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #4facfe, #00f2fe)"></button>
                            <button type="button" onclick="applyGradientPreset('#43e97b', '#38f9d7')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #43e97b, #38f9d7)"></button>
                            <button type="button" onclick="applyGradientPreset('#fa709a', '#fee140')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #fa709a, #fee140)"></button>
                            <button type="button" onclick="applyGradientPreset('#a18cd1', '#fbc2eb')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #a18cd1, #fbc2eb)"></button>
                            <button type="button" onclick="applyGradientPreset('#ff0844', '#ffb199')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #ff0844, #ffb199)"></button>
                            <button type="button" onclick="applyGradientPreset('#0250c5', '#d43f8d')" class="w-12 h-8 rounded" style="background: linear-gradient(90deg, #0250c5, #d43f8d)"></button>
                        </div>
                    </div>
                    <!-- Preview -->
                    <div id="gradient-preview" class="h-10 rounded mt-2" style="background: linear-gradient(90deg, #667eea, #764ba2)"></div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Link Type</label>
                    <select id="banner-link-type" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" onchange="updateBannerLinkFields()">
                        <option value="none">No Link (Just Display)</option>
                        <option value="url">External URL</option>
                        <option value="product">Link to Product</option>
                        <option value="category">Link to Category</option>
                    </select>
                </div>

                <div id="banner-link-url-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">External URL</label>
                    <input type="url" id="banner-link-url" placeholder="https://example.com" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>

                <div id="banner-link-product-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">Select Product</label>
                    <select id="banner-link-product" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">-- Select a Product --</option>
                        <!-- Products will be loaded dynamically -->
                    </select>
                </div>

                <div id="banner-link-category-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">Select Category</label>
                    <select id="banner-link-category" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">-- Select a Category --</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>

                <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="banner-is-active" class="mr-3 w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                        <span class="text-gray-700 font-medium">Set as Active Banner</span>
                    </label>
                    <p class="text-sm text-gray-600 mt-2 ml-8">Only one banner can be active. Activating this will deactivate all others.</p>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                        <i class="fas fa-save mr-2"></i>Save Banner
                    </button>
                    <button type="button" onclick="closeModal('banner-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulk-upload-modal" class="modal">
        <div class="modal-content max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Bulk Upload Products</h3>
                <button onclick="closeModal('bulk-upload-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                        <div>
                            <p class="font-medium text-blue-800 mb-2">Instructions for Excel Upload:</p>
                            <ol class="text-sm text-blue-700 list-decimal ml-4 space-y-1">
                                <li>Download the template Excel file below</li>
                                <li>Fill in product details: Name, Price, Stock, Category, Description</li>
                                <li>Save the file and upload it here</li>
                                <li>Product images can be uploaded manually later</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3 mb-6">
                    <button onclick="downloadTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-download mr-2"></i>Download Template
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1example/edit" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fab fa-google mr-2"></i>Google Sheets Template
                    </a>
                </div>
            </div>
            
            <form id="bulk-upload-form" onsubmit="handleBulkUpload(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Upload Excel File</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition cursor-pointer" onclick="document.getElementById('excel-input').click()">
                        <input type="file" id="excel-input" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleExcelSelect(event)">
                        <i class="fas fa-file-excel text-5xl text-green-600 mb-3"></i>
                        <p class="text-gray-600 mb-1">Click to upload Excel file</p>
                        <p class="text-sm text-gray-400">Supports: .xlsx, .xls, .csv</p>
                        <p id="selected-file-name" class="text-sm text-purple-600 font-medium mt-2 hidden"></p>
                    </div>
                </div>
                
                <div id="upload-preview" class="mb-6 hidden">
                    <h4 class="font-medium text-gray-800 mb-2">Preview (First 5 rows):</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 border text-left text-sm">Name</th>
                                    <th class="px-4 py-2 border text-left text-sm">Price</th>
                                    <th class="px-4 py-2 border text-left text-sm">Stock</th>
                                    <th class="px-4 py-2 border text-left text-sm">Category</th>
                                </tr>
                            </thead>
                            <tbody id="preview-table-body"></tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <span id="total-rows-count">0</span> products ready to upload
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" id="upload-btn" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium" disabled>
                        <i class="fas fa-upload mr-2"></i>Upload Products
                    </button>
                    <button type="button" onclick="closeModal('bulk-upload-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Offer Modal -->
    <div id="offer-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="offer-modal-title">Add Offer</h3>
                <button onclick="closeModal('offer-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="offer-form" onsubmit="saveOffer(event)">
                <input type="hidden" id="offer-id">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Title <span class="text-red-500">*</span></label>
                    <input type="text" id="offer-title" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="e.g., 20% Off on All Products">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Description <span class="text-red-500">*</span></label>
                    <textarea id="offer-description" required rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="Describe the offer details..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Discount Type <span class="text-red-500">*</span></label>
                        <select id="offer-discount-type" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                            <option value="">Select Type</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (‚Çπ)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Discount Value <span class="text-red-500">*</span></label>
                        <input type="number" id="offer-discount-value" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="e.g., 20 or 100">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Offer Type <span class="text-red-500">*</span></label>
                    <select id="offer-type" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" onchange="togglePromoCodeField()">
                        <option value="automatic">Automatic (Applied automatically when conditions met)</option>
                        <option value="promo_code">Promo Code (Customer must enter code)</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">
                        <span id="offer-type-help-automatic">This offer will be automatically applied when minimum purchase is met.</span>
                        <span id="offer-type-help-promo" class="hidden">Customer must enter the promo code during checkout.</span>
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div id="promo-code-field">
                        <label class="block text-gray-700 font-medium mb-2">
                            Promo Code <span id="promo-code-required" class="text-red-500 hidden">*</span>
                        </label>
                        <input type="text" id="offer-code" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="e.g., SAVE20" style="text-transform: uppercase;">
                        <p class="text-sm text-gray-500 mt-1">Leave empty for automatic offers</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Minimum Purchase (‚Çπ)</label>
                        <input type="number" id="offer-min-purchase" min="0" step="0.01" value="0" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="e.g., 500">
                        <p class="text-sm text-gray-500 mt-1">Set 0 for no minimum</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Start Date</label>
                        <input type="datetime-local" id="offer-start-date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">End Date</label>
                        <input type="datetime-local" id="offer-end-date" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="offer-active" checked class="mr-2 w-4 h-4">
                        <span class="text-gray-700 font-medium">Active (visible to customers)</span>
                    </label>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                        <i class="fas fa-save mr-2"></i>Save Offer
                    </button>
                    <button type="button" onclick="closeModal('offer-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Welcome Popup Modal -->
    <div id="popup-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <form id="popup-form" onsubmit="savePopup(event)">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800" id="popup-modal-title">Create Welcome Popup</h3>
                    <button type="button" onclick="closeModal('popup-modal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <input type="hidden" id="popup-id">

                <!-- Popup Image Upload -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Popup Image/Poster <span class="text-red-500">*</span></label>
                    <div id="popup-image-dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 transition" onclick="document.getElementById('popup-image-input').click()">
                        <div id="popup-dropzone-content">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Click to upload poster image</p>
                            <p class="text-xs text-gray-400 mt-1">Recommended: 800x600px or larger</p>
                        </div>
                        <div id="popup-image-preview" class="hidden">
                            <img id="popup-preview-img" class="max-h-48 mx-auto rounded">
                            <button type="button" onclick="removePopupImage(event)" class="mt-2 px-4 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                    <input type="file" id="popup-image-input" accept="image/*" class="hidden" onchange="handlePopupImageSelect(event)">
                    <input type="hidden" id="popup-cloudinary-public-id">
                </div>

                <!-- Title -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Title <span class="text-red-500">*</span></label>
                    <input type="text" id="popup-title" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="e.g., New Arrivals!">
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Description (Optional)</label>
                    <textarea id="popup-description" rows="2" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="Short description for the popup..."></textarea>
                </div>

                <!-- Link Type -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Link Type</label>
                    <select id="popup-link-type" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" onchange="updatePopupLinkFields()">
                        <option value="none">No Link (Just Display)</option>
                        <option value="url">External URL</option>
                        <option value="product">Link to Product</option>
                        <option value="category">Link to Category</option>
                    </select>
                </div>

                <!-- Link Target (URL input, shown when link type is 'url') -->
                <div id="popup-url-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">External URL</label>
                    <input type="url" id="popup-link-url" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" placeholder="https://example.com">
                </div>

                <!-- Product Selector (shown when link type is 'product') -->
                <div id="popup-product-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">Select Product</label>
                    <select id="popup-link-product" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">-- Select a Product --</option>
                    </select>
                </div>

                <!-- Category Selector (shown when link type is 'category') -->
                <div id="popup-category-field" class="mb-4 hidden">
                    <label class="block text-gray-700 font-medium mb-2">Select Category</label>
                    <select id="popup-link-category" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">-- Select a Category --</option>
                    </select>
                </div>

                <!-- Poster Orientation -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Poster Orientation</label>
                    <select id="popup-orientation" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="landscape">Landscape (Wide - Best for banners)</option>
                        <option value="portrait">Portrait (Tall - Best for mobile)</option>
                        <option value="square">Square (Balanced)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose based on your poster image dimensions</p>
                </div>

                <!-- Celebration Effect Type -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Celebration Effect</label>
                    <select id="popup-effect-type" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="confetti">Confetti (Colorful falling pieces)</option>
                        <option value="fireworks">Fireworks (Explosive bursts)</option>
                        <option value="sparkles">Sparkles (Twinkling stars)</option>
                        <option value="all">All Effects (Grand celebration)</option>
                        <option value="none">No Effects (Clean look)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Background celebration effects when popup appears</p>
                </div>

                <!-- Display Frequency -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Display Frequency</label>
                    <select id="popup-frequency" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="always">Always (Every Page Load)</option>
                        <option value="once_per_session">Once Per Session</option>
                        <option value="once_per_day">Once Per Day</option>
                    </select>
                </div>

                <!-- Active Status -->
                <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="popup-active" class="mr-3 w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                        <span class="text-gray-700 font-medium">Set as Active Popup</span>
                    </label>
                    <p class="text-sm text-gray-600 mt-2 ml-8">Only one popup can be active. Activating this will deactivate all others.</p>
                </div>

                <!-- Popup Info Box -->
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                    <p class="font-medium mb-1"><i class="fas fa-info-circle mr-1"></i> How it works:</p>
                    <ul class="list-disc ml-5 space-y-1">
                        <li>The entire poster is clickable (no separate button)</li>
                        <li>Users tap outside the poster or press ESC to close</li>
                        <li>Link to products/categories shows item details when tapped</li>
                    </ul>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                        <i class="fas fa-save mr-2"></i>Save Popup
                    </button>
                    <button type="button" onclick="closeModal('popup-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const backendBaseUrl = window.APP_CONFIG?.BACKEND_URL || 'https://arun-karyana-backend.onrender.com';
        let currentUserId = null;
        let allOrders = [];
        let currentImageData = null;
        let additionalImagesData = []; // Array to store additional images

        // Mobile Menu Functionality
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');

        function openMobileMenu() {
            sidebar.classList.add('mobile-open');
            mobileOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling when menu open
        }

        function closeMobileMenu() {
            sidebar.classList.remove('mobile-open');
            mobileOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        hamburgerBtn.addEventListener('click', openMobileMenu);
        closeSidebarBtn.addEventListener('click', closeMobileMenu);
        mobileOverlay.addEventListener('click', closeMobileMenu);

        // Close mobile menu when nav item is clicked
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            currentUserId = localStorage.getItem('loggedInUserId');
            if (!currentUserId) {
                alert('Please login first!');
                window.location.href = 'login.html';
                return;
            }

            // Verify admin role
            fetch(`${backendBaseUrl}/user_role/${currentUserId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success || data.role !== 'admin') {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'index.html';
                        return;
                    }
                    // Load admin name
                    return fetch(`${backendBaseUrl}/profile/${currentUserId}`);
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('admin-name').textContent = data.user.name;
                    }
                    // Load dashboard data
                    loadDashboard();
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    alert('Authentication failed. Please login again.');
                    window.location.href = 'login.html';
                });
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('bg-gray-800', 'text-white', 'active'));
                item.classList.add('bg-gray-800', 'text-white', 'active');
                
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
                
                // Show selected section
                document.getElementById(`${section}-section`).classList.remove('hidden');
                
                // Update header
                const titles = {
                    dashboard: 'Dashboard',
                    orders: 'Orders Management',
                    products: 'Products Management',
                    categories: 'Category Management',
                    offers: 'Offers & Promotions',
                    banners: 'Offer Banners',
                    customers: 'Customer Management',
                    reviews: 'Customer Reviews',
                    messages: 'Contact Messages'
                };
                const subtitles = {
                    dashboard: "Welcome back! Here's what's happening today.",
                    orders: 'Manage and track all customer orders',
                    products: 'Add, edit, and manage your product inventory',
                    categories: 'Add, edit, and delete product categories',
                    offers: 'Create and manage promotional offers and discounts',
                    banners: 'Create and manage running LED-style banners for homepage',
                    customers: 'View customer information and statistics',
                    reviews: 'Manage and feature customer reviews',
                    messages: 'View and respond to customer inquiries'
                };
                document.getElementById('section-title').textContent = titles[section];
                document.getElementById('section-subtitle').textContent = subtitles[section];
                
                // Load section data
                if (section === 'orders') loadOrders();
                if (section === 'products') loadProducts();
                if (section === 'categories') loadCategories();
                if (section === 'offers') loadOffers();
                if (section === 'banners') loadBanners();
                if (section === 'popups') loadPopups();
                if (section === 'customers') loadCustomers();
                if (section === 'reviews') loadReviews();
                if (section === 'messages') loadMessages();
            });
        });

        // Load Dashboard
        function loadDashboard() {
            fetch(`${backendBaseUrl}/admin/dashboard/stats`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stat-sales').textContent = stats.todays_sales.toFixed(0);
                    document.getElementById('stat-orders-today').textContent = stats.todays_orders;
                    document.getElementById('stat-pending').textContent = stats.pending_orders;
                    document.getElementById('stat-products').textContent = stats.total_products;
                    document.getElementById('stat-low-stock').textContent = stats.low_stock_products;
                    document.getElementById('stat-customers').textContent = stats.total_customers;
                    
                    // Update low stock badge appearance
                    const lowStockBadge = document.getElementById('low-stock-badge');
                    if (stats.low_stock_products > 0) {
                        lowStockBadge.className = 'mt-2 px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full hover:bg-red-600 transition animate-pulse';
                    } else {
                        lowStockBadge.className = 'mt-2 px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full';
                        lowStockBadge.innerHTML = '<i class="fas fa-check-circle mr-1"></i><span id="stat-low-stock">0</span> All Good!';
                    }
                    
                    // Display recent orders
                    const tbody = document.getElementById('recent-orders-tbody');
                    if (stats.recent_orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No orders yet</td></tr>';
                    } else {
                        tbody.innerHTML = stats.recent_orders.map(order => `
                            <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="viewOrderDetails('${order._id}')">
                                <td class="py-3 px-4 font-mono text-sm">#${order._id.slice(-6)}</td>
                                <td class="py-3 px-4">${order.customer_info.name}</td>
                                <td class="py-3 px-4">‚Çπ${order.total_amount}</td>
                                <td class="py-3 px-4"><span class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')}">${order.status}</span></td>
                                <td class="py-3 px-4 text-sm text-gray-600">${new Date(order.order_date).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    }
                }
            })
            .catch(error => console.error('Error loading dashboard:', error));
        }

        // Load Orders
        function loadOrders() {
            fetch(`${backendBaseUrl}/admin/orders`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allOrders = data.orders;
                    displayOrders(allOrders);
                }
            })
            .catch(error => console.error('Error loading orders:', error));
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-mono text-sm">#${order._id.slice(-6)}</td>
                    <td class="py-3 px-4">${order.customer_info.name}</td>
                    <td class="py-3 px-4">${order.customer_info.phone}</td>
                    <td class="py-3 px-4">‚Çπ${order.total_amount}</td>
                    <td class="py-3 px-4">
                        <select onchange="updateOrderStatus('${order._id}', this.value)" class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')} border-none cursor-pointer">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(order.order_date).toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="viewOrderDetails('${order._id}')" class="text-purple-600 hover:text-purple-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter orders
        document.getElementById('order-status-filter').addEventListener('change', filterOrders);
        document.getElementById('order-search').addEventListener('input', filterOrders);

        function filterOrders() {
            const statusFilter = document.getElementById('order-status-filter').value;
            const searchQuery = document.getElementById('order-search').value.toLowerCase();
            
            let filtered = allOrders;
            
            if (statusFilter) {
                filtered = filtered.filter(order => order.status === statusFilter);
            }
            
            if (searchQuery) {
                filtered = filtered.filter(order => 
                    order.customer_info.name.toLowerCase().includes(searchQuery) ||
                    order.customer_info.phone.includes(searchQuery)
                );
            }
            
            displayOrders(filtered);
        }

        // Update order status
        function updateOrderStatus(orderId, newStatus) {
            let cancellationReason = null;
            
            // If cancelling, ask for reason
            if (newStatus === 'Cancelled') {
                cancellationReason = prompt('Please enter the reason for cancellation (this will be sent to the customer):');
                
                if (!cancellationReason || cancellationReason.trim() === '') {
                    alert('Cancellation reason is required!');
                    loadOrders(); // Reload to reset select
                    return;
                }
            } else {
                if (!confirm(`Change order status to "${newStatus}"?`)) {
                    loadOrders(); // Reload to reset select
                    return;
                }
            }

            const requestBody = {
                order_id: orderId,
                status: newStatus
            };
            
            if (cancellationReason) {
                requestBody.cancellation_reason = cancellationReason.trim();
            }

            fetch(`${backendBaseUrl}/admin/orders/update-status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order status updated successfully!');
                    loadOrders();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                    loadOrders();
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                alert('Failed to update order status');
                loadOrders();
            });
        }

        // View order details
        function viewOrderDetails(orderId) {
            fetch(`${backendBaseUrl}/order/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.order;
                    const itemsHTML = order.items.map(item => `
                        <tr class="border-b">
                            <td class="py-2">${item.name}</td>
                            <td class="py-2 text-center">${item.quantity}</td>
                            <td class="py-2 text-right">‚Çπ${item.price}</td>
                            <td class="py-2 text-right font-medium">‚Çπ${item.price * item.quantity}</td>
                        </tr>
                    `).join('');

                    document.getElementById('order-details-content').innerHTML = `
                        <div class="mb-4">
                            <p class="text-gray-600">Order ID</p>
                            <p class="text-lg font-mono font-bold">#${order._id}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600">Customer Details</p>
                            <p class="font-medium">${order.customer_info.name}</p>
                            <p class="text-sm text-gray-600">${order.customer_info.phone}</p>
                            <p class="text-sm text-gray-600">${order.customer_info.address}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600 mb-2">Order Items</p>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-2 text-left">Product</th>
                                        <th class="py-2 text-center">Qty</th>
                                        <th class="py-2 text-right">Price</th>
                                        <th class="py-2 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsHTML}</tbody>
                                <tfoot class="border-t-2">
                                    <tr>
                                        <td colspan="3" class="py-2 text-right font-medium">Subtotal:</td>
                                        <td class="py-2 text-right">‚Çπ${order.subtotal || 0}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="py-2 text-right font-medium">Delivery Fee:</td>
                                        <td class="py-2 text-right">‚Çπ${order.delivery_fee || 0}</td>
                                    </tr>
                                    <tr class="font-bold text-lg">
                                        <td colspan="3" class="py-2 text-right">Total Amount:</td>
                                        <td class="py-2 text-right text-purple-600">‚Çπ${order.total_amount}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600">Status</p>
                            <p class="text-lg"><span class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')}">${order.status}</span></p>
                        </div>
                        <div>
                            <p class="text-gray-600">Order Date</p>
                            <p class="text-sm">${new Date(order.order_date).toLocaleString()}</p>
                        </div>
                    `;
                    document.getElementById('order-modal').classList.add('active');
                }
            })
            .catch(error => console.error('Error loading order details:', error));
        }

        // Load Products
        function loadProducts() {
            fetch(`${backendBaseUrl}/admin/products`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allProducts = data.products;
                    filterProducts(currentFilter); // Apply current filter
                }
            })
            .catch(error => console.error('Error loading products:', error));
        }

        function displayProducts(products) {
            const grid = document.getElementById('products-grid');
            if (products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No products found</div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const stockValue = product.stock || 0;
                const isLowStock = stockValue < 10;
                const stockBadgeClass = isLowStock ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300';
                const stockIcon = isLowStock ? 'fa-exclamation-triangle' : 'fa-check-circle';
                
                return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition ${isLowStock ? 'ring-2 ring-red-500' : ''}">
                    ${isLowStock ? '<div class="bg-red-600 text-white text-xs font-bold px-3 py-1 text-center"><i class="fas fa-exclamation-triangle mr-1"></i>LOW STOCK ALERT</div>' : ''}
                    <img src="${product.image || 'https://via.placeholder.com/300x300?text=No+Image'}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h4 class="font-bold text-lg mb-2 truncate">${product.name}</h4>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-2xl font-bold text-purple-600">‚Çπ${product.price}</span>
                            <span class="text-sm font-semibold px-2 py-1 rounded border ${stockBadgeClass}">
                                <i class="fas ${stockIcon} mr-1"></i>${stockValue} in stock
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 capitalize">${product.category}</p>
                        <div class="flex gap-2">
                            <button onclick="editProduct('${product._id}')" class="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteProduct('${product._id}')" class="flex-1 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Store all products for filtering
        let allProducts = [];
        let currentFilter = 'all';

        // Navigate to Products section and show low stock items
        function navigateToLowStock() {
            // Switch to products section
            document.querySelectorAll('.content-section').forEach(section => section.classList.add('hidden'));
            document.getElementById('products-section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active-nav'));
            document.querySelector('.nav-item[data-section="products"]').classList.add('active-nav');
            
            // Load products first if not loaded, then filter
            if (allProducts.length === 0) {
                loadProducts().then(() => {
                    filterProducts('low-stock');
                });
            } else {
                // Filter to show only low stock
                filterProducts('low-stock');
            }
        }

        // Filter products by stock status
        function filterProducts(filterType) {
            currentFilter = filterType;
            
            // Update button styles
            const allBtn = document.getElementById('filter-all-products');
            const lowStockBtn = document.getElementById('filter-low-stock');
            
            if (filterType === 'all') {
                allBtn.className = 'px-4 py-3 bg-purple-600 text-white rounded-lg transition hover:bg-purple-700 text-sm sm:text-base';
                lowStockBtn.className = 'px-4 py-3 bg-gray-200 text-gray-700 rounded-lg transition hover:bg-red-100 hover:text-red-700 text-sm sm:text-base';
                displayProducts(allProducts);
            } else if (filterType === 'low-stock') {
                allBtn.className = 'px-4 py-3 bg-gray-200 text-gray-700 rounded-lg transition hover:bg-purple-100 hover:text-purple-700 text-sm sm:text-base';
                lowStockBtn.className = 'px-4 py-3 bg-red-600 text-white rounded-lg transition hover:bg-red-700 text-sm sm:text-base';
                const lowStockProducts = allProducts.filter(p => (p.stock || 0) < 10);
                displayProducts(lowStockProducts);
            }
        }

        // Show add product modal
        // Populate category dropdown
        function populateCategoryDropdown() {
            fetch(`${backendBaseUrl}/categories`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.categories) {
                        const select = document.getElementById('product-category');
                        // Keep the first "Select Category" option
                        select.innerHTML = '<option value="">Select Category</option>';
                        
                        // Add all categories from database
                        data.categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = cat.name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading categories:', error));
        }

        function showAddProductModal() {
            document.getElementById('product-modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('cloudinary-public-id').value = '';
            currentImageData = null;
            additionalImagesData = []; // Reset additional images
            document.getElementById('dropzone-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            displayAdditionalImages(); // Clear additional images preview
            populateCategoryDropdown(); // Load categories from database
            document.getElementById('product-modal').classList.add('active');
        }

        // Edit product
        function editProduct(productId) {
            fetch(`${backendBaseUrl}/admin/products`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const product = data.products.find(p => p._id === productId);
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'Edit Product';
                        document.getElementById('product-id').value = product._id;
                        document.getElementById('product-name').value = product.name;
                        document.getElementById('product-price').value = product.price;
                        document.getElementById('product-stock').value = product.stock || 0;
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('cloudinary-public-id').value = product.cloudinary_public_id || '';
                        
                        // Populate category dropdown then set the product's category
                        populateCategoryDropdown();
                        // Use setTimeout to ensure dropdown is populated before setting value
                        setTimeout(() => {
                            document.getElementById('product-category').value = product.category;
                        }, 100);
                        
                        if (product.image) {
                            document.getElementById('dropzone-content').classList.add('hidden');
                            document.getElementById('image-preview').classList.remove('hidden');
                            document.getElementById('preview-img').src = product.image;
                            currentImageData = product.image;
                        }
                        
                        // Load additional images if available
                        if (product.images && product.images.length > 1) {
                            additionalImagesData = product.images.slice(1); // Skip first image (it's the primary)
                        } else {
                            additionalImagesData = [];
                        }
                        displayAdditionalImages();
                        
                        document.getElementById('product-modal').classList.add('active');
                    }
                }
            })
            .catch(error => console.error('Error loading product:', error));
        }

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('dropzone-content').classList.add('hidden');
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('preview-img').src = currentImageData;
            };
            reader.readAsDataURL(file);
        }

        // Remove image
        function removeImage(event) {
            event.stopPropagation();
            currentImageData = null;
            document.getElementById('cloudinary-public-id').value = '';
            document.getElementById('dropzone-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-input').value = '';
        }

        // Handle additional images selection
        function handleAdditionalImagesSelect(event) {
            const files = Array.from(event.target.files);
            
            if (additionalImagesData.length + files.length > 5) {
                alert('Maximum 5 additional images allowed');
                return;
            }
            
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} is too large. Max 5MB per image.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    additionalImagesData.push({
                        data: e.target.result,
                        name: file.name
                    });
                    displayAdditionalImages();
                };
                reader.readAsDataURL(file);
            });
        }

        // Display additional images preview
        function displayAdditionalImages() {
            const container = document.getElementById('additional-images-preview');
            if (additionalImagesData.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = additionalImagesData.map((img, index) => {
                // Handle both object format {data: base64} and direct URL string
                const imgSrc = typeof img === 'string' ? img : (img.data || img.url || '');
                return `
                    <div class="relative border rounded overflow-hidden">
                        <img src="${imgSrc}" class="w-full h-20 object-cover">
                        <button type="button" onclick="removeAdditionalImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Remove additional image
        function removeAdditionalImage(index) {
            additionalImagesData.splice(index, 1);
            displayAdditionalImages();
        }

        // Drag and drop handlers
        const dropzone = document.getElementById('image-dropzone');
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('drag-over');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const input = document.getElementById('image-input');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                handleImageSelect({ target: input });
            }
        });

        // Save product
        async function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const isEdit = !!productId;
            
            console.log('=== SAVING PRODUCT ===');
            console.log('Is Edit Mode:', isEdit);
            console.log('Additional Images Data:', additionalImagesData);
            
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value,
                description: document.getElementById('product-description').value,
                cloudinary_public_id: document.getElementById('cloudinary-public-id').value
            };
            
            // Initialize images arrays
            productData.images = [];
            productData.cloudinary_public_ids = [];
            
            // Upload primary image to Cloudinary if image was changed
            if (currentImageData && currentImageData.startsWith('data:image')) {
                try {
                    const uploadResponse = await fetch(`${backendBaseUrl}/admin/upload-image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-ID': currentUserId
                        },
                        body: JSON.stringify({ image_data: currentImageData })
                    });
                    
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        productData.image = uploadData.url;
                        productData.cloudinary_public_id = uploadData.public_id;
                        productData.images.push(uploadData.url);
                        productData.cloudinary_public_ids.push(uploadData.public_id);
                    } else {
                        alert('Error uploading primary image: ' + uploadData.message);
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading primary image:', error);
                    alert('Failed to upload primary image');
                    return;
                }
            } else if (currentImageData) {
                productData.image = currentImageData;
                productData.images.push(currentImageData);
            }
            
            // Upload additional images to Cloudinary
            if (additionalImagesData.length > 0) {
                for (const imgData of additionalImagesData) {
                    // Check if it's a new image (base64 data)
                    const isNewImage = typeof imgData === 'object' && imgData.data && imgData.data.startsWith('data:image');
                    const isExistingUrl = typeof imgData === 'string' && imgData.startsWith('http');
                    
                    if (isNewImage) {
                        // Upload new image to Cloudinary
                        try {
                            const uploadResponse = await fetch(`${backendBaseUrl}/admin/upload-image`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'User-ID': currentUserId
                                },
                                body: JSON.stringify({ image_data: imgData.data })
                            });
                            
                            const uploadData = await uploadResponse.json();
                            if (uploadData.success) {
                                productData.images.push(uploadData.url);
                                productData.cloudinary_public_ids.push(uploadData.public_id);
                            }
                        } catch (error) {
                            console.error('Error uploading additional image:', error);
                        }
                    } else if (isExistingUrl) {
                        // Keep existing image URL
                        productData.images.push(imgData);
                    }
                }
            }
            
            console.log('=== FINAL PRODUCT DATA ===');
            console.log('Images Array:', productData.images);
            console.log('Images Count:', productData.images.length);
            console.log('Full Product Data:', productData);
            
            // Save product
            const url = isEdit 
                ? `${backendBaseUrl}/admin/products/update/${productId}`
                : `${backendBaseUrl}/admin/products/add`;
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(isEdit ? 'Product updated successfully!' : 'Product added successfully!');
                    closeModal('product-modal');
                    loadProducts();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving product:', error);
                alert('Failed to save product');
            });
        }

        // Delete product
        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            fetch(`${backendBaseUrl}/admin/products/delete/${productId}`, {
                method: 'DELETE',
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Product deleted successfully!');
                    loadProducts();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                alert('Failed to delete product');
            });
        }

        // ========== OFFERS MANAGEMENT ==========

        let allOffers = [];

        // Load Offers
        function loadOffers() {
            fetch(`${backendBaseUrl}/admin/offers`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allOffers = data.offers;
                    displayOffers(allOffers);
                }
            })
            .catch(error => console.error('Error loading offers:', error));
        }

        // Display Offers
        function displayOffers(offers) {
            const grid = document.getElementById('offers-grid');
            if (offers.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No offers found</div>';
                return;
            }
            
            grid.innerHTML = offers.map(offer => {
                const isActive = offer.active;
                const discountText = offer.discount_type === 'percentage' 
                    ? `${offer.discount_value}% OFF` 
                    : `‚Çπ${offer.discount_value} OFF`;
                
                const startDate = offer.start_date ? new Date(offer.start_date).toLocaleDateString() : 'Not set';
                const endDate = offer.end_date ? new Date(offer.end_date).toLocaleDateString() : 'No expiry';
                
                return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition border-l-4 ${isActive ? 'border-green-500' : 'border-gray-300'}">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-xl mb-1">${offer.title}</h4>
                                <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${isActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                    ${isActive ? '‚úì Active' : '‚úó Inactive'}
                                </span>
                            </div>
                            <div class="text-3xl font-bold text-purple-600">${discountText}</div>
                        </div>
                        
                        <p class="text-gray-600 text-sm mb-4">${offer.description}</p>
                        
                        <div class="space-y-2 text-sm mb-4">
                            ${offer.code ? `<div class="flex items-center"><i class="fas fa-ticket-alt text-purple-500 w-5"></i><span class="ml-2 font-mono font-bold">${offer.code}</span></div>` : ''}
                            ${offer.min_purchase > 0 ? `<div class="flex items-center"><i class="fas fa-shopping-cart text-gray-500 w-5"></i><span class="ml-2">Min. Purchase: ‚Çπ${offer.min_purchase}</span></div>` : ''}
                            <div class="flex items-center"><i class="fas fa-calendar text-gray-500 w-5"></i><span class="ml-2">${startDate} - ${endDate}</span></div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="toggleOfferStatus('${offer._id}')" class="flex-1 py-2 ${isActive ? 'bg-orange-500' : 'bg-green-500'} text-white rounded hover:opacity-90 transition text-sm">
                                <i class="fas ${isActive ? 'fa-pause' : 'fa-play'} mr-1"></i> ${isActive ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="editOffer('${offer._id}')" class="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteOffer('${offer._id}')" class="flex-1 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Show add offer modal
        function showAddOfferModal() {
            document.getElementById('offer-modal-title').textContent = 'Add Offer';
            document.getElementById('offer-form').reset();
            document.getElementById('offer-id').value = '';
            document.getElementById('offer-active').checked = true;
            document.getElementById('offer-modal').classList.add('active');
        }

        // Edit offer
        function editOffer(offerId) {
            const offer = allOffers.find(o => o._id === offerId);
            if (offer) {
                document.getElementById('offer-modal-title').textContent = 'Edit Offer';
                document.getElementById('offer-id').value = offer._id;
                document.getElementById('offer-title').value = offer.title;
                document.getElementById('offer-description').value = offer.description;
                document.getElementById('offer-discount-type').value = offer.discount_type;
                document.getElementById('offer-discount-value').value = offer.discount_value;
                document.getElementById('offer-code').value = offer.code || '';
                document.getElementById('offer-min-purchase').value = offer.min_purchase || 0;
                
                // Handle dates
                if (offer.start_date) {
                    const startDate = new Date(offer.start_date);
                    document.getElementById('offer-start-date').value = startDate.toISOString().slice(0, 16);
                }
                if (offer.end_date) {
                    const endDate = new Date(offer.end_date);
                    document.getElementById('offer-end-date').value = endDate.toISOString().slice(0, 16);
                }
                
                document.getElementById('offer-active').checked = offer.active;
                document.getElementById('offer-modal').classList.add('active');
            }
        }

        // Toggle promo code field requirement based on offer type
        function togglePromoCodeField() {
            const offerType = document.getElementById('offer-type').value;
            const promoCodeInput = document.getElementById('offer-code');
            const promoCodeRequired = document.getElementById('promo-code-required');
            const helpAutomatic = document.getElementById('offer-type-help-automatic');
            const helpPromo = document.getElementById('offer-type-help-promo');
            
            if (offerType === 'promo_code') {
                promoCodeInput.required = true;
                promoCodeRequired.classList.remove('hidden');
                helpAutomatic.classList.add('hidden');
                helpPromo.classList.remove('hidden');
            } else {
                promoCodeInput.required = false;
                promoCodeRequired.classList.add('hidden');
                helpAutomatic.classList.remove('hidden');
                helpPromo.classList.add('hidden');
            }
        }

        // Save offer
        async function saveOffer(event) {
            event.preventDefault();
            
            const offerId = document.getElementById('offer-id').value;
            const offerType = document.getElementById('offer-type').value;
            const promoCode = document.getElementById('offer-code').value?.trim().toUpperCase();
            
            // Validate promo code is provided for promo_code type offers
            if (offerType === 'promo_code' && !promoCode) {
                alert('Please enter a promo code for promo code type offers.');
                document.getElementById('offer-code').focus();
                return;
            }
            
            const offerData = {
                title: document.getElementById('offer-title').value,
                description: document.getElementById('offer-description').value,
                discount_type: document.getElementById('offer-discount-type').value,
                discount_value: parseFloat(document.getElementById('offer-discount-value').value),
                offer_type: offerType,
                code: promoCode || null,
                min_purchase: parseFloat(document.getElementById('offer-min-purchase').value) || 0,
                start_date: document.getElementById('offer-start-date').value || null,
                end_date: document.getElementById('offer-end-date').value || null,
                active: document.getElementById('offer-active').checked
            };
            
            const url = offerId 
                ? `${backendBaseUrl}/admin/offers/update/${offerId}`
                : `${backendBaseUrl}/admin/offers/add`;
            const method = offerId ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'User-ID': currentUserId
                    },
                    body: JSON.stringify(offerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    closeModal('offer-modal');
                    loadOffers();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error saving offer:', error);
                alert('Failed to save offer');
            }
        }

        // Toggle offer status
        function toggleOfferStatus(offerId) {
            if (!confirm('Are you sure you want to change the offer status?')) return;
            
            fetch(`${backendBaseUrl}/admin/offers/toggle/${offerId}`, {
                method: 'PUT',
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadOffers();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error toggling offer status:', error);
                alert('Failed to update offer status');
            });
        }

        // Delete offer
        function deleteOffer(offerId) {
            if (!confirm('Are you sure you want to delete this offer? This action cannot be undone.')) return;
            
            fetch(`${backendBaseUrl}/admin/offers/delete/${offerId}`, {
                method: 'DELETE',
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Offer deleted successfully!');
                    loadOffers();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting offer:', error);
                alert('Failed to delete offer');
            });
        }

        // Load Customers
        function loadCustomers() {
            fetch(`${backendBaseUrl}/admin/customers/stats`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCustomers(data.customers);
                }
            })
            .catch(error => console.error('Error loading customers:', error));
        }

        function displayCustomers(customers) {
            const tbody = document.getElementById('customers-tbody');
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No customers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = customers.map(customer => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-medium">${customer.name}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4">${customer.phone}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${customer.order_count}</span>
                    </td>
                    <td class="py-3 px-4 text-right font-bold text-green-600">‚Çπ${customer.total_spent.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${customer.created_at ? new Date(customer.created_at).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('userId');
                window.location.href = 'login.html';
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        // --- Bulk Upload Management ---
        let parsedExcelData = [];

        function showBulkUploadModal() {
            document.getElementById('bulk-upload-modal').classList.add('active');
            document.getElementById('bulk-upload-form').reset();
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('selected-file-name').classList.add('hidden');
            document.getElementById('upload-btn').disabled = true;
            parsedExcelData = [];
        }

        function downloadTemplate() {
            // Create template data
            const templateData = [
                ['Name', 'Price', 'Stock', 'Category', 'Description'],
                ['Lux Soap', '83', '100', 'soaps', 'Premium beauty soap'],
                ['Tata Salt 1kg', '27', '200', 'food', 'Iodized table salt'],
                ['Fortune Oil 1L', '157', '50', 'food', 'Refined sunflower oil']
            ];

            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 30}, // Name
                {wch: 10}, // Price
                {wch: 10}, // Stock
                {wch: 15}, // Category
                {wch: 50}  // Description
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            
            // Download file
            XLSX.writeFile(wb, 'product_template.xlsx');
        }

        function handleExcelSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('selected-file-name').textContent = file.name;
            document.getElementById('selected-file-name').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Get first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        alert('The Excel file is empty!');
                        return;
                    }

                    // Validate and parse data
                    parsedExcelData = jsonData.map(row => ({
                        name: row.Name || row.name || '',
                        price: parseFloat(row.Price || row.price || 0),
                        stock: parseInt(row.Stock || row.stock || 0),
                        category: (row.Category || row.category || 'general').toLowerCase(),
                        description: row.Description || row.description || '',
                        image_url: row.Image || row.image_url || 'https://placehold.co/300x300/cccccc/666666?text=Product'
                    })).filter(product => product.name && product.price > 0);

                    if (parsedExcelData.length === 0) {
                        alert('No valid products found in the file!');
                        return;
                    }

                    // Show preview
                    displayExcelPreview(parsedExcelData);
                    document.getElementById('upload-btn').disabled = false;

                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    alert('Failed to parse Excel file. Please check the format.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function displayExcelPreview(data) {
            const preview = document.getElementById('upload-preview');
            const tbody = document.getElementById('preview-table-body');
            const totalCount = document.getElementById('total-rows-count');

            // Show first 5 rows
            const previewData = data.slice(0, 5);
            tbody.innerHTML = previewData.map(product => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2 border text-sm">${product.name}</td>
                    <td class="px-4 py-2 border text-sm">‚Çπ${product.price}</td>
                    <td class="px-4 py-2 border text-sm">${product.stock}</td>
                    <td class="px-4 py-2 border text-sm">${product.category}</td>
                </tr>
            `).join('');

            totalCount.textContent = data.length;
            preview.classList.remove('hidden');
        }

        async function handleBulkUpload(event) {
            event.preventDefault();

            if (parsedExcelData.length === 0) {
                alert('Please select a valid Excel file first!');
                return;
            }

            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

            try {
                const response = await fetch(`${backendBaseUrl}/admin/products/bulk-upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-ID': currentUserId
                    },
                    body: JSON.stringify({ products: parsedExcelData })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`Successfully uploaded ${result.created_count} products!\nFailed: ${result.failed_count}`);
                    closeModal('bulk-upload-modal');
                    loadProducts(); // Reload products list
                } else {
                    alert(result.message || 'Failed to upload products');
                }
            } catch (error) {
                console.error('Error uploading products:', error);
                alert('An error occurred while uploading products');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Products';
            }
        }

        // --- Reviews Management ---
        let allReviews = [];
        let currentReviewFilter = 'all';

        // Load Reviews
        function loadReviews() {
            fetch(`${backendBaseUrl}/admin/reviews`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allReviews = data.reviews;
                    filterReviews(currentReviewFilter);
                }
            })
            .catch(error => console.error('Error loading reviews:', error));
        }

        // Filter Reviews
        function filterReviews(filter) {
            currentReviewFilter = filter;
            
            // Update filter button states
            document.querySelectorAll('.review-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white', 'active');
                btn.classList.add('bg-gray-200');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-purple-600', 'text-white', 'active');
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-gray-200');

            let filteredReviews = allReviews;
            
            if (filter === 'featured') {
                filteredReviews = allReviews.filter(r => r.featured);
            } else if (filter === '5' || filter === '4') {
                filteredReviews = allReviews.filter(r => r.rating === parseInt(filter));
            }

            displayReviews(filteredReviews);
        }

        // Display Reviews
        function displayReviews(reviews) {
            const grid = document.getElementById('reviews-grid');
            
            if (reviews.length === 0) {
                grid.innerHTML = '<div class="text-center py-8 text-gray-400 col-span-full">No reviews found</div>';
                return;
            }

            grid.innerHTML = reviews.map(review => {
                const stars = Array.from({length: 5}, (_, i) => {
                    return i < review.rating 
                        ? '<i class="fas fa-star text-yellow-500"></i>'
                        : '<i class="far fa-star text-gray-300"></i>';
                }).join('');

                const date = new Date(review.created_at).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Determine if we should show profile picture or initials
                const userInitial = review.user_name.charAt(0).toUpperCase();
                const profilePictureHtml = review.user_profile_picture 
                    ? `<img src="${review.user_profile_picture}" alt="${review.user_name}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null; this.outerHTML='<div class=\\'w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg\\'>${userInitial}</div>';">`
                    : `<div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">${userInitial}</div>`;
                
                return `
                    <div class="bg-gray-50 p-4 rounded-lg border ${review.featured ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200'}">
                        ${review.featured ? '<div class="flex items-center gap-1 text-yellow-600 text-sm font-semibold mb-2"><i class="fas fa-star"></i> Featured</div>' : ''}
                        <div class="flex items-center mb-3">
                            <div class="mr-3">
                                ${profilePictureHtml}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">${review.user_name}</div>
                                <div class="flex items-center gap-1">${stars}</div>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-3 text-sm italic">"${review.review_text.length > 120 ? review.review_text.substring(0, 120) + '...' : review.review_text}"</p>
                        <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                            <span><i class="fas fa-calendar mr-1"></i>${date}</span>
                            <span><i class="fas fa-shopping-bag mr-1"></i>Order #${review.order_id.substring(0, 6)}</span>
                        </div>
                        <button onclick="toggleFeatureReview('${review._id}', ${!review.featured})" 
                                class="w-full py-2 rounded ${review.featured ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} transition font-medium text-sm">
                            <i class="fas ${review.featured ? 'fa-times' : 'fa-check'} mr-1"></i>
                            ${review.featured ? 'Unfeature' : 'Feature'} Review
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Toggle Feature Status
        function toggleFeatureReview(reviewId, featured) {
            if (!confirm(`Are you sure you want to ${featured ? 'feature' : 'unfeature'} this review?`)) {
                return;
            }

            fetch(`${backendBaseUrl}/admin/reviews/feature`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({
                    review_id: reviewId,
                    featured: featured
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message || `Review ${featured ? 'featured' : 'unfeatured'} successfully!`);
                    loadReviews(); // Reload reviews
                } else {
                    alert(data.message || 'Failed to update review');
                }
            })
            .catch(error => {
                console.error('Error updating review:', error);
                alert('An error occurred while updating the review');
            });
        }

        // --- Messages Management ---
        let allMessages = [];
        let currentMessageFilter = 'all';

        // Load Messages
        function loadMessages() {
            fetch(`${backendBaseUrl}/admin/messages`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allMessages = data.messages;
                    filterMessages(currentMessageFilter);
                }
            })
            .catch(error => console.error('Error loading messages:', error));
        }

        // Filter Messages
        function filterMessages(filter) {
            currentMessageFilter = filter;
            
            // Update filter button states
            document.querySelectorAll('.message-filter-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white', 'active');
                btn.classList.add('bg-gray-200');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('bg-purple-600', 'text-white', 'active');
            document.querySelector(`[data-filter="${filter}"]`).classList.remove('bg-gray-200');

            let filteredMessages = allMessages;
            
            if (filter === 'unread') {
                filteredMessages = allMessages.filter(m => !m.read);
            } else if (filter === 'read') {
                filteredMessages = allMessages.filter(m => m.read);
            }

            displayMessages(filteredMessages);
        }

        // Display Messages
        function displayMessages(messages) {
            const grid = document.getElementById('messages-grid');
            
            if (messages.length === 0) {
                grid.innerHTML = '<div class="text-center py-8 text-gray-400">No messages found</div>';
                return;
            }

            grid.innerHTML = messages.map(message => {
                const date = new Date(message.created_at).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="bg-gray-50 p-3 md:p-5 rounded-lg border ${message.read ? 'border-gray-200' : 'border-blue-400 bg-blue-50'} hover:shadow-md transition">
                        <div class="flex flex-col sm:flex-row justify-between items-start mb-3 gap-3 sm:gap-0">
                            <div class="flex items-center gap-2 w-full sm:w-auto">
                                <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                                    ${message.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <h4 class="font-semibold text-gray-800 text-sm md:text-base truncate">${message.name}</h4>
                                    <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 text-xs md:text-sm text-gray-600">
                                        <span class="truncate"><i class="fas fa-envelope mr-1"></i>${message.email}</span>
                                        <span><i class="fas fa-phone mr-1"></i>${message.phone}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 self-end sm:self-auto">
                                ${!message.read ? '<span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">NEW</span>' : ''}
                                <span class="text-xs text-gray-500 whitespace-nowrap"><i class="far fa-clock mr-1"></i>${date}</span>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200 mb-3">
                            <p class="text-gray-700 text-xs md:text-sm whitespace-pre-wrap break-words">${message.message}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button onclick="toggleReadStatus('${message._id}', ${!message.read})" 
                                    class="px-3 md:px-4 py-2 rounded ${message.read ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-green-100 text-green-700 hover:bg-green-200'} transition font-medium text-xs md:text-sm w-full sm:w-auto">
                                <i class="fas ${message.read ? 'fa-envelope' : 'fa-envelope-open'} mr-1"></i>
                                Mark as ${message.read ? 'Unread' : 'Read'}
                            </button>
                            <a href="mailto:${message.email}" class="px-3 md:px-4 py-2 rounded bg-purple-100 text-purple-700 hover:bg-purple-200 transition font-medium text-xs md:text-sm text-center w-full sm:w-auto">
                                <i class="fas fa-reply mr-1"></i>Reply via Email
                            </a>
                            <button onclick="deleteContactMessage('${message._id}')" 
                                    class="px-3 md:px-4 py-2 rounded bg-red-100 text-red-700 hover:bg-red-200 transition font-medium text-xs md:text-sm w-full sm:w-auto sm:ml-auto">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle Read/Unread Status
        function toggleReadStatus(messageId, read) {
            fetch(`${backendBaseUrl}/admin/messages/mark-read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({
                    message_id: messageId,
                    read: read
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMessages(); // Reload messages
                } else {
                    alert(data.message || 'Failed to update message status');
                }
            })
            .catch(error => {
                console.error('Error updating message status:', error);
                alert('An error occurred while updating the message');
            });
        }

        // Delete Message
        function deleteContactMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) {
                return;
            }

            fetch(`${backendBaseUrl}/admin/messages/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({
                    message_id: messageId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Message deleted successfully!');
                    loadMessages(); // Reload messages
                } else {
                    alert(data.message || 'Failed to delete message');
                }
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                alert('An error occurred while deleting the message');
            });
        }

        // ========== CATEGORY MANAGEMENT ==========

        // Load Categories
        function loadCategories() {
            fetch(`${backendBaseUrl}/categories`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCategories(data.categories);
                    } else {
                        console.error('Failed to load categories');
                        document.getElementById('categories-grid').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load categories</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    document.getElementById('categories-grid').innerHTML = '<div class="text-center py-8 text-red-500">Error loading categories</div>';
                });
        }

        // Display Categories
        function displayCategories(categories) {
            const grid = document.getElementById('categories-grid');
            
            if (categories.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No categories found. Add your first category!</div>';
                return;
            }

            grid.innerHTML = categories.map(cat => `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-th-large text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">${cat.name}</h4>
                                <p class="text-sm text-gray-500">${cat.product_count} products</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editCategory('${cat.name}')" class="flex-1 px-3 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition text-sm">
                            <i class="fas fa-edit mr-1"></i>Rename
                        </button>
                        <button onclick="deleteCategory('${cat.name}', ${cat.product_count})" class="flex-1 px-3 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition text-sm">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Show Add Category Modal
        function showAddCategoryModal() {
            const categoryName = prompt('Enter new category name:');
            if (!categoryName || !categoryName.trim()) return;

            fetch(`${backendBaseUrl}/admin/categories/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({ category_name: categoryName.trim() })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCategories();
                } else {
                    alert(data.message || 'Failed to add category');
                }
            })
            .catch(error => {
                console.error('Error adding category:', error);
                alert('An error occurred while adding the category');
            });
        }

        // Edit Category
        function editCategory(oldName) {
            const newName = prompt(`Rename category "${oldName}" to:`, oldName);
            if (!newName || !newName.trim() || newName.trim() === oldName) return;

            fetch(`${backendBaseUrl}/admin/categories/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({ 
                    old_category: oldName, 
                    new_category: newName.trim() 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCategories();
                    // Refresh products if on products section
                    if (!document.getElementById('products-section').classList.contains('hidden')) {
                        loadProducts();
                    }
                } else {
                    alert(data.message || 'Failed to rename category');
                }
            })
            .catch(error => {
                console.error('Error renaming category:', error);
                alert('An error occurred while renaming the category');
            });
        }

        // Delete Category
        function deleteCategory(categoryName, productCount) {
            const message = productCount > 0 
                ? `Are you sure you want to delete "${categoryName}"?\n\n${productCount} products will be moved to "Uncategorized".`
                : `Are you sure you want to delete "${categoryName}"?`;
            
            if (!confirm(message)) return;

            fetch(`${backendBaseUrl}/admin/categories/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({ category_name: categoryName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCategories();
                    // Refresh products if on products section
                    if (!document.getElementById('products-section').classList.contains('hidden')) {
                        loadProducts();
                    }
                } else {
                    alert(data.message || 'Failed to delete category');
                }
            })
            .catch(error => {
                console.error('Error deleting category:', error);
                alert('An error occurred while deleting the category');
            });
        }

        // ========== BANNER MANAGEMENT ==========

        // Load Banners
        function loadBanners() {
            fetch(`${backendBaseUrl}/admin/banners`, {
                headers: { 'User-ID': currentUserId }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayBanners(data.banners);
                    } else {
                        console.error('Failed to load banners');
                        document.getElementById('banners-grid').innerHTML = '<div class="text-center py-8 text-red-500">Failed to load banners</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading banners:', error);
                    document.getElementById('banners-grid').innerHTML = '<div class="text-center py-8 text-red-500">Error loading banners</div>';
                });
        }

        // Display Banners
        function displayBanners(banners) {
            const grid = document.getElementById('banners-grid');
            
            if (banners.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No banners found. Create your first banner!</div>';
                return;
            }

            grid.innerHTML = banners.map(banner => `
                <div class="border-2 ${banner.is_active ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'} rounded-lg p-4 hover:shadow-lg transition">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                ${banner.is_active ? '<span class="px-2 py-1 bg-green-500 text-white text-xs font-bold rounded">ACTIVE</span>' : '<span class="px-2 py-1 bg-gray-300 text-gray-700 text-xs font-bold rounded">INACTIVE</span>'}
                                ${banner.link_type !== 'none' ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded"><i class="fas fa-link mr-1"></i>${banner.link_type.toUpperCase()}</span>` : ''}
                            </div>
                            <p class="text-gray-800 font-medium mb-2">${banner.text}</p>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <span>Colors:</span>
                                <span class="px-2 py-1 rounded" style="background-color: ${banner.background_color}; color: ${banner.text_color};">Sample</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="toggleBannerStatus('${banner._id}', ${banner.is_active})" class="flex-1 px-3 py-2 ${banner.is_active ? 'bg-orange-50 text-orange-600 hover:bg-orange-100' : 'bg-green-50 text-green-600 hover:bg-green-100'} rounded transition text-sm font-medium">
                            <i class="fas fa-${banner.is_active ? 'eye-slash' : 'eye'} mr-1"></i>${banner.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button onclick="editBanner('${banner._id}')" class="flex-1 px-3 py-2 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition text-sm font-medium">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="deleteBanner('${banner._id}')" class="flex-1 px-3 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition text-sm font-medium">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Show Add Banner Modal
        function showAddBannerModal() {
            document.getElementById('banner-modal-title').textContent = 'Add Banner';
            document.getElementById('banner-form').reset();
            document.getElementById('banner-id').value = '';
            document.getElementById('banner-bg-color').value = '#FF6B6B';
            document.getElementById('banner-text-color').value = '#FFFFFF';
            document.getElementById('banner-gradient-enabled').checked = false;
            document.getElementById('banner-gradient-start').value = '#667eea';
            document.getElementById('banner-gradient-end').value = '#764ba2';
            document.getElementById('banner-gradient-text-color').value = '#FFFFFF';
            toggleGradientOptions();
            updateBannerLinkFields();
            populateBannerSelectors(); // Load products and categories
            // Clear additional announcements
            document.getElementById('additional-announcements').innerHTML = '';
            announcementCount = 0;
            document.getElementById('banner-modal').classList.add('active');
        }

        // Update Banner Link Fields
        function updateBannerLinkFields() {
            const linkType = document.getElementById('banner-link-type').value;
            document.getElementById('banner-link-url-field').classList.toggle('hidden', linkType !== 'url');
            document.getElementById('banner-link-product-field').classList.toggle('hidden', linkType !== 'product');
            document.getElementById('banner-link-category-field').classList.toggle('hidden', linkType !== 'category');
        }

        // Toggle Gradient Options
        function toggleGradientOptions() {
            const isGradient = document.getElementById('banner-gradient-enabled').checked;
            document.getElementById('solid-color-options').classList.toggle('hidden', isGradient);
            document.getElementById('gradient-options').classList.toggle('hidden', !isGradient);
            if (isGradient) {
                updateGradientPreview();
            }
        }

        // Apply Gradient Preset
        function applyGradientPreset(start, end) {
            document.getElementById('banner-gradient-start').value = start;
            document.getElementById('banner-gradient-end').value = end;
            updateGradientPreview();
        }

        // Update Gradient Preview
        function updateGradientPreview() {
            const start = document.getElementById('banner-gradient-start').value;
            const end = document.getElementById('banner-gradient-end').value;
            document.getElementById('gradient-preview').style.background = `linear-gradient(90deg, ${start}, ${end})`;
        }

        // Add event listeners for gradient color changes
        document.addEventListener('DOMContentLoaded', function() {
            const gradientStart = document.getElementById('banner-gradient-start');
            const gradientEnd = document.getElementById('banner-gradient-end');
            if (gradientStart) gradientStart.addEventListener('input', updateGradientPreview);
            if (gradientEnd) gradientEnd.addEventListener('input', updateGradientPreview);
        });
        
        // Toggle Emoji Picker
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.classList.toggle('hidden');
        }
        
        // Insert Text/Emoji into Banner Text
        function insertText(text) {
            const textarea = document.getElementById('banner-text');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentText = textarea.value;
            textarea.value = currentText.substring(0, start) + text + currentText.substring(end);
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
        }
        
        // Add Additional Announcement Field
        let announcementCount = 0;
        function addAnnouncementField() {
            if (announcementCount >= 5) {
                alert('Maximum 5 additional announcements allowed');
                return;
            }
            announcementCount++;
            const container = document.getElementById('additional-announcements');
            const fieldHtml = `
                <div class="flex gap-2 items-center announcement-field" data-index="${announcementCount}">
                    <textarea rows="2" placeholder="Additional announcement ${announcementCount}" class="flex-1 px-3 py-2 border rounded-lg text-sm additional-announcement"></textarea>
                    <button type="button" onclick="removeAnnouncementField(${announcementCount})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', fieldHtml);
        }
        
        // Remove Announcement Field
        function removeAnnouncementField(index) {
            const field = document.querySelector(`.announcement-field[data-index="${index}"]`);
            if (field) {
                field.remove();
                announcementCount--;
            }
        }

        // Save Banner
        function saveBanner(event) {
            event.preventDefault();
            
            const bannerId = document.getElementById('banner-id').value;
            const isEdit = !!bannerId;
            
            // Collect main banner text
            const mainText = document.getElementById('banner-text').value;
            
            // Collect additional announcements
            const additionalTexts = [];
            document.querySelectorAll('.additional-announcement').forEach(textarea => {
                const text = textarea.value.trim();
                if (text) {
                    additionalTexts.push(text);
                }
            });
            
            // Combine all texts (main + additional)
            const allTexts = [mainText, ...additionalTexts];
            
            // Check if gradient is enabled
            const isGradient = document.getElementById('banner-gradient-enabled').checked;
            
            // Get link target based on type
            const linkType = document.getElementById('banner-link-type').value;
            let linkId = '';
            let linkCategory = '';
            
            if (linkType === 'product') {
                linkId = document.getElementById('banner-link-product').value || '';
            } else if (linkType === 'category') {
                linkCategory = document.getElementById('banner-link-category').value || '';
            }
            
            const bannerData = {
                text: mainText, // Keep main text for backward compatibility
                texts: allTexts, // Array of all announcement texts
                background_color: isGradient ? '' : document.getElementById('banner-bg-color').value,
                text_color: isGradient ? document.getElementById('banner-gradient-text-color').value : document.getElementById('banner-text-color').value,
                gradient_enabled: isGradient,
                gradient_start: isGradient ? document.getElementById('banner-gradient-start').value : '',
                gradient_end: isGradient ? document.getElementById('banner-gradient-end').value : '',
                link_type: linkType,
                link_url: document.getElementById('banner-link-url').value || '',
                link_id: linkId,
                link_category: linkCategory,
                is_active: document.getElementById('banner-is-active').checked
            };
            
            const url = isEdit 
                ? `${backendBaseUrl}/admin/banners/update/${bannerId}`
                : `${backendBaseUrl}/admin/banners/add`;
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify(bannerData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('banner-modal');
                    loadBanners();
                } else {
                    alert(data.message || 'Failed to save banner');
                }
            })
            .catch(error => {
                console.error('Error saving banner:', error);
                alert('An error occurred while saving the banner');
            });
        }

        // Edit Banner
        async function editBanner(bannerId) {
            try {
                const response = await fetch(`${backendBaseUrl}/admin/banners`, {
                    headers: { 'User-ID': currentUserId }
                });
                const data = await response.json();
                
                if (data.success) {
                    const banner = data.banners.find(b => b._id === bannerId);
                    if (banner) {
                        document.getElementById('banner-modal-title').textContent = 'Edit Banner';
                        document.getElementById('banner-id').value = banner._id;
                        document.getElementById('banner-text').value = banner.text || '';
                        document.getElementById('banner-bg-color').value = banner.background_color || '#FF6B6B';
                        document.getElementById('banner-text-color').value = banner.text_color || '#FFFFFF';
                        document.getElementById('banner-link-type').value = banner.link_type || 'none';
                        document.getElementById('banner-link-url').value = banner.link_url || '';
                        document.getElementById('banner-is-active').checked = banner.is_active || false;
                        
                        // Handle gradient settings
                        if (banner.gradient_enabled) {
                            document.getElementById('banner-gradient-enabled').checked = true;
                            document.getElementById('banner-gradient-start').value = banner.gradient_start || '#667eea';
                            document.getElementById('banner-gradient-end').value = banner.gradient_end || '#764ba2';
                            document.getElementById('banner-gradient-text-color').value = banner.text_color || '#FFFFFF';
                            toggleGradientOptions();
                            updateGradientPreview();
                        }
                        
                        updateBannerLinkFields();
                        
                        // Populate product and category selectors then set values
                        await populateBannerSelectors();
                        
                        // Now set the selected product or category
                        if (banner.link_type === 'product' && banner.link_id) {
                            document.getElementById('banner-link-product').value = banner.link_id;
                        } else if (banner.link_type === 'category' && banner.link_category) {
                            document.getElementById('banner-link-category').value = banner.link_category;
                        }
                        
                        // Load additional announcements
                        document.getElementById('additional-announcements').innerHTML = '';
                        if (banner.texts && banner.texts.length > 1) {
                            banner.texts.slice(1).forEach(text => {
                                if (text && text.trim()) {
                                    const div = document.createElement('div');
                                    div.className = 'flex gap-2';
                                    div.innerHTML = `
                                        <textarea class="additional-announcement flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600" rows="1" placeholder="Additional announcement...">${text}</textarea>
                                        <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    `;
                                    document.getElementById('additional-announcements').appendChild(div);
                                }
                            });
                        }
                        
                        document.getElementById('banner-modal').classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Error loading banner:', error);
            }
        }
        
        // Populate Banner Product and Category Selectors
        async function populateBannerSelectors() {
            // Populate products
            try {
                const productsResponse = await fetch(`${backendBaseUrl}/admin/products`, {
                    headers: { 'User-ID': currentUserId }
                });
                const productsData = await productsResponse.json();
                if (productsData.success) {
                    const productSelect = document.getElementById('banner-link-product');
                    productSelect.innerHTML = '<option value="">-- Select a Product --</option>' +
                        productsData.products.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Error loading products for banner:', e);
            }
            
            // Populate categories
            try {
                const categoriesResponse = await fetch(`${backendBaseUrl}/categories`);
                const categoriesData = await categoriesResponse.json();
                if (categoriesData.success) {
                    const categorySelect = document.getElementById('banner-link-category');
                    categorySelect.innerHTML = '<option value="">-- Select a Category --</option>' +
                        categoriesData.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Error loading categories for banner:', e);
            }
        }

        // Toggle Banner Status
        function toggleBannerStatus(bannerId, currentStatus) {
            const action = currentStatus ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this banner?${!currentStatus ? '\n\nThis will deactivate all other banners.' : ''}`)) {
                return;
            }

            fetch(`${backendBaseUrl}/admin/banners/toggle/${bannerId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadBanners();
                } else {
                    alert(data.message || 'Failed to toggle banner status');
                }
            })
            .catch(error => {
                console.error('Error toggling banner:', error);
                alert('An error occurred while updating the banner');
            });
        }

        // Delete Banner
        function deleteBanner(bannerId) {
            if (!confirm('Are you sure you want to delete this banner? This action cannot be undone.')) {
                return;
            }

            fetch(`${backendBaseUrl}/admin/banners/delete/${bannerId}`, {
                method: 'DELETE',
                headers: {
                    'User-ID': currentUserId
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadBanners();
                } else {
                    alert(data.message || 'Failed to delete banner');
                }
            })
            .catch(error => {
                console.error('Error deleting banner:', error);
                alert('An error occurred while deleting the banner');
            });
        }

        // ========== WELCOME POPUP MANAGEMENT ==========
        
        let currentPopupImageData = null;

        // Load Popups
        function loadPopups() {
            fetch(`${backendBaseUrl}/admin/popups`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPopups(data.popups);
                } else {
                    document.getElementById('popups-grid').innerHTML = '<p class="text-center text-gray-500 col-span-full">Failed to load popups</p>';
                }
            })
            .catch(error => {
                console.error('Error loading popups:', error);
                document.getElementById('popups-grid').innerHTML = '<p class="text-center text-red-500 col-span-full">Error loading popups</p>';
            });
        }

        // Display Popups
        function displayPopups(popups) {
            const grid = document.getElementById('popups-grid');
            
            if (!popups || popups.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500 col-span-full py-8">No popups created yet. Click "Create Popup" to get started.</p>';
                return;
            }

            grid.innerHTML = popups.map(popup => `
                <div class="border rounded-lg overflow-hidden ${popup.is_active ? 'ring-2 ring-green-500' : ''}">
                    <div class="relative">
                        ${popup.image_url ? 
                            `<img src="${popup.image_url}" class="w-full h-40 object-cover" alt="${popup.title}">` :
                            `<div class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-400">
                                <i class="fas fa-image text-4xl"></i>
                            </div>`
                        }
                        ${popup.is_active ? 
                            `<span class="absolute top-2 right-2 px-2 py-1 bg-green-500 text-white text-xs rounded-full">
                                <i class="fas fa-check mr-1"></i>ACTIVE
                            </span>` : ''
                        }
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-gray-800 mb-1">${popup.title}</h4>
                        <p class="text-sm text-gray-500 mb-2 truncate">${popup.description || 'No description'}</p>
                        <div class="text-xs text-gray-400 mb-3">
                            <span class="mr-2"><i class="fas fa-clock mr-1"></i>${popup.display_frequency?.replace('_', ' ') || 'always'}</span>
                            <span><i class="fas fa-link mr-1"></i>${popup.link_type || 'none'}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editPopup('${popup._id}')" class="flex-1 px-3 py-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-sm">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="togglePopup('${popup._id}', ${popup.is_active})" class="flex-1 px-3 py-2 ${popup.is_active ? 'bg-yellow-100 text-yellow-600 hover:bg-yellow-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} rounded text-sm">
                                <i class="fas fa-${popup.is_active ? 'pause' : 'play'} mr-1"></i>${popup.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deletePopup('${popup._id}')" class="px-3 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show Add Popup Modal
        function showAddPopupModal() {
            document.getElementById('popup-modal-title').textContent = 'Create Welcome Popup';
            document.getElementById('popup-form').reset();
            document.getElementById('popup-id').value = '';
            currentPopupImageData = null;
            document.getElementById('popup-dropzone-content').classList.remove('hidden');
            document.getElementById('popup-image-preview').classList.add('hidden');
            document.getElementById('popup-cloudinary-public-id').value = '';
            // Set default values for new fields
            document.getElementById('popup-orientation').value = 'landscape';
            document.getElementById('popup-effect-type').value = 'confetti';
            updatePopupLinkFields();
            populatePopupSelectors();
            document.getElementById('popup-modal').classList.add('active');
        }

        // Populate Product and Category Selectors for Popup
        async function populatePopupSelectors() {
            // Populate products
            try {
                const productsResponse = await fetch(`${backendBaseUrl}/admin/products`, {
                    headers: { 'User-ID': currentUserId }
                });
                const productsData = await productsResponse.json();
                if (productsData.success) {
                    const productSelect = document.getElementById('popup-link-product');
                    productSelect.innerHTML = '<option value="">-- Select a Product --</option>' +
                        productsData.products.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Error loading products for popup:', e);
            }

            // Populate categories
            try {
                const categoriesResponse = await fetch(`${backendBaseUrl}/categories`);
                const categoriesData = await categoriesResponse.json();
                if (categoriesData.success) {
                    const categorySelect = document.getElementById('popup-link-category');
                    categorySelect.innerHTML = '<option value="">-- Select a Category --</option>' +
                        categoriesData.categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                }
            } catch (e) {
                console.error('Error loading categories for popup:', e);
            }
        }

        // Update Link Fields Based on Link Type
        function updatePopupLinkFields() {
            const linkType = document.getElementById('popup-link-type').value;
            document.getElementById('popup-url-field').classList.toggle('hidden', linkType !== 'url');
            document.getElementById('popup-product-field').classList.toggle('hidden', linkType !== 'product');
            document.getElementById('popup-category-field').classList.toggle('hidden', linkType !== 'category');
        }

        // Handle Popup Image Selection
        function handlePopupImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentPopupImageData = e.target.result;
                document.getElementById('popup-dropzone-content').classList.add('hidden');
                document.getElementById('popup-image-preview').classList.remove('hidden');
                document.getElementById('popup-preview-img').src = currentPopupImageData;
            };
            reader.readAsDataURL(file);
        }

        // Remove Popup Image
        function removePopupImage(event) {
            event.stopPropagation();
            currentPopupImageData = null;
            document.getElementById('popup-cloudinary-public-id').value = '';
            document.getElementById('popup-dropzone-content').classList.remove('hidden');
            document.getElementById('popup-image-preview').classList.add('hidden');
            document.getElementById('popup-image-input').value = '';
        }

        // Save Popup
        async function savePopup(event) {
            event.preventDefault();

            const popupId = document.getElementById('popup-id').value;
            const isEdit = !!popupId;

            // Get link target based on type
            const linkType = document.getElementById('popup-link-type').value;
            let linkUrl = '';
            let linkTarget = '';

            if (linkType === 'url') {
                linkUrl = document.getElementById('popup-link-url').value;
            } else if (linkType === 'product') {
                linkTarget = document.getElementById('popup-link-product').value;
            } else if (linkType === 'category') {
                linkTarget = document.getElementById('popup-link-category').value;
            }

            const popupData = {
                title: document.getElementById('popup-title').value,
                description: document.getElementById('popup-description').value,
                link_type: linkType,
                link_url: linkUrl,
                link_target: linkTarget,
                button_text: document.getElementById('popup-button-text').value || 'View Now',
                orientation: document.getElementById('popup-orientation').value || 'landscape',
                effect_type: document.getElementById('popup-effect-type').value || 'confetti',
                display_frequency: document.getElementById('popup-frequency').value,
                is_active: document.getElementById('popup-active').checked,
                cloudinary_public_id: document.getElementById('popup-cloudinary-public-id').value
            };

            // Upload image if new
            if (currentPopupImageData && currentPopupImageData.startsWith('data:image')) {
                try {
                    const uploadResponse = await fetch(`${backendBaseUrl}/admin/upload-image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-ID': currentUserId
                        },
                        body: JSON.stringify({ image_data: currentPopupImageData })
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        popupData.image_url = uploadData.url;
                        popupData.cloudinary_public_id = uploadData.public_id;
                    } else {
                        alert('Error uploading image: ' + uploadData.message);
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading popup image:', error);
                    alert('Failed to upload image');
                    return;
                }
            } else if (currentPopupImageData) {
                popupData.image_url = currentPopupImageData;
            }

            // Save popup
            const url = isEdit 
                ? `${backendBaseUrl}/admin/popups/update/${popupId}`
                : `${backendBaseUrl}/admin/popups/add`;
            const method = isEdit ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify(popupData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(isEdit ? 'Popup updated successfully!' : 'Popup created successfully!');
                    closeModal('popup-modal');
                    loadPopups();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving popup:', error);
                alert('An error occurred while saving the popup');
            });
        }

        // Edit Popup
        function editPopup(popupId) {
            fetch(`${backendBaseUrl}/admin/popups`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const popup = data.popups.find(p => p._id === popupId);
                    if (popup) {
                        document.getElementById('popup-modal-title').textContent = 'Edit Popup';
                        document.getElementById('popup-id').value = popup._id;
                        document.getElementById('popup-title').value = popup.title || '';
                        document.getElementById('popup-description').value = popup.description || '';
                        document.getElementById('popup-link-type').value = popup.link_type || 'none';
                        document.getElementById('popup-link-url').value = popup.link_url || '';
                        document.getElementById('popup-button-text').value = popup.button_text || 'View Now';
                        document.getElementById('popup-orientation').value = popup.orientation || 'landscape';
                        document.getElementById('popup-effect-type').value = popup.effect_type || 'confetti';
                        document.getElementById('popup-frequency').value = popup.display_frequency || 'always';
                        document.getElementById('popup-active').checked = popup.is_active || false;
                        document.getElementById('popup-cloudinary-public-id').value = popup.cloudinary_public_id || '';

                        if (popup.image_url) {
                            currentPopupImageData = popup.image_url;
                            document.getElementById('popup-dropzone-content').classList.add('hidden');
                            document.getElementById('popup-image-preview').classList.remove('hidden');
                            document.getElementById('popup-preview-img').src = popup.image_url;
                        } else {
                            currentPopupImageData = null;
                            document.getElementById('popup-dropzone-content').classList.remove('hidden');
                            document.getElementById('popup-image-preview').classList.add('hidden');
                        }

                        updatePopupLinkFields();
                        populatePopupSelectors().then(() => {
                            // Set link target after selectors are populated
                            if (popup.link_type === 'product') {
                                document.getElementById('popup-link-product').value = popup.link_target || '';
                            } else if (popup.link_type === 'category') {
                                document.getElementById('popup-link-category').value = popup.link_target || '';
                            }
                        });

                        document.getElementById('popup-modal').classList.add('active');
                    }
                }
            })
            .catch(error => console.error('Error loading popup:', error));
        }

        // Toggle Popup Active Status
        function togglePopup(popupId, currentStatus) {
            const action = currentStatus ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this popup?${!currentStatus ? '\n\nThis will deactivate all other popups.' : ''}`)) {
                return;
            }

            // We update by setting is_active
            fetch(`${backendBaseUrl}/admin/popups`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const popup = data.popups.find(p => p._id === popupId);
                    if (popup) {
                        popup.is_active = !currentStatus;
                        return fetch(`${backendBaseUrl}/admin/popups/update/${popupId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'User-ID': currentUserId
                            },
                            body: JSON.stringify(popup)
                        });
                    }
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Popup ${currentStatus ? 'deactivated' : 'activated'} successfully!`);
                    loadPopups();
                } else {
                    alert('Failed to update popup status');
                }
            })
            .catch(error => {
                console.error('Error toggling popup:', error);
                alert('An error occurred while updating the popup');
            });
        }

        // Delete Popup
        function deletePopup(popupId) {
            if (!confirm('Are you sure you want to delete this popup? This action cannot be undone.')) {
                return;
            }

            fetch(`${backendBaseUrl}/admin/popups/delete/${popupId}`, {
                method: 'DELETE',
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Popup deleted successfully!');
                    loadPopups();
                } else {
                    alert(data.message || 'Failed to delete popup');
                }
            })
            .catch(error => {
                console.error('Error deleting popup:', error);
                alert('An error occurred while deleting the popup');
            });
        }
    </script>
</body>
</html>
