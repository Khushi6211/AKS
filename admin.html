<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Arun Karyana Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar.closed {
                transform: translateX(-100%);
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .stat-card-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .dropzone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dropzone:hover, .dropzone.drag-over {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-out-for-delivery { background-color: #e0e7ff; color: #3730a3; }
        .status-delivered { background-color: #d1fae5; color: #065f46; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div class="sidebar fixed left-0 top-0 h-screen w-64 bg-gray-900 text-white z-50 shadow-xl">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white mb-1">Arun Karyana</h1>
            <p class="text-gray-400 text-sm">Admin Dashboard</p>
        </div>
        
        <nav class="mt-6">
            <a href="#" data-section="dashboard" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition active">
                <i class="fas fa-chart-line w-6"></i>
                <span class="ml-3">Dashboard</span>
            </a>
            <a href="#" data-section="orders" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-shopping-bag w-6"></i>
                <span class="ml-3">Orders</span>
            </a>
            <a href="#" data-section="products" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-box w-6"></i>
                <span class="ml-3">Products</span>
            </a>
            <a href="#" data-section="customers" class="nav-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-800 hover:text-white transition">
                <i class="fas fa-users w-6"></i>
                <span class="ml-3">Customers</span>
            </a>
        </nav>
        
        <div class="absolute bottom-0 w-full p-6 border-t border-gray-700">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                    <i class="fas fa-user text-white"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium" id="admin-name">Admin</p>
                    <p class="text-xs text-gray-400">Administrator</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="ml-64 p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-gray-800" id="section-title">Dashboard</h2>
                <p class="text-gray-600 mt-1" id="section-subtitle">Welcome back! Here's what's happening today.</p>
            </div>
            <button onclick="location.href='index.html'" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-store mr-2"></i>View Store
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Today's Sales</p>
                            <h3 class="text-3xl font-bold mt-2">â‚¹<span id="stat-sales">0</span></h3>
                            <p class="text-xs mt-2 opacity-70"><span id="stat-orders-today">0</span> orders</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-rupee-sign text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-2 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Pending Orders</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-pending">0</span></h3>
                            <p class="text-xs mt-2 opacity-70">Need attention</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-3 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Total Products</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-products">0</span></h3>
                            <p class="text-xs mt-2 opacity-70"><span id="stat-low-stock">0</span> low stock</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-box text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card-4 rounded-xl shadow-lg p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-80">Total Customers</p>
                            <h3 class="text-3xl font-bold mt-2"><span id="stat-customers">0</span></h3>
                            <p class="text-xs mt-2 opacity-70">Registered users</p>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-full p-3">
                            <i class="fas fa-users text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Orders</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Order ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Customer</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Amount</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Status</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-tbody">
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">All Orders</h3>
                    <div class="flex gap-2">
                        <select id="order-status-filter" class="px-4 py-2 border rounded-lg">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <input type="text" id="order-search" placeholder="Search by customer..." class="px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Order ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Customer</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Phone</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Amount</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Status</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Date</th>
                                <th class="text-center py-3 px-4 text-gray-600 font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Products Management</h3>
                    <button onclick="showAddProductModal()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-plus mr-2"></i>Add Product
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="products-grid">
                    <div class="text-center py-8 text-gray-400">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers-section" class="content-section hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Customer Management</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Name</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Email</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Phone</th>
                                <th class="text-center py-3 px-4 text-gray-600 font-medium">Orders</th>
                                <th class="text-right py-3 px-4 text-gray-600 font-medium">Total Spent</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-medium">Joined</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-gray-400">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Order Details</h3>
                <button onclick="closeModal('order-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800" id="product-modal-title">Add Product</h3>
                <button onclick="closeModal('product-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                <input type="hidden" id="cloudinary-public-id">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Product Image</label>
                    <div id="image-dropzone" class="dropzone" onclick="document.getElementById('image-input').click()">
                        <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                        <div id="dropzone-content">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-400 mt-1">PNG, JPG, WEBP (max. 5MB)</p>
                        </div>
                        <div id="image-preview" class="hidden">
                            <img id="preview-img" class="max-w-full h-auto rounded-lg">
                            <button type="button" onclick="removeImage(event)" class="mt-2 text-red-600 hover:text-red-700">
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Product Name</label>
                    <input type="text" id="product-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Price (â‚¹)</label>
                        <input type="number" id="product-price" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Stock</label>
                        <input type="number" id="product-stock" required min="0" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Category</label>
                    <select id="product-category" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                        <option value="">Select Category</option>
                        <option value="food">Food & Staples</option>
                        <option value="beverages">Beverages</option>
                        <option value="soaps">Soaps & Detergents</option>
                        <option value="personal-care">Personal Care</option>
                        <option value="snacks">Snacks</option>
                        <option value="dairy">Dairy</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Description (Optional)</label>
                    <textarea id="product-description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="flex-1 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                        <i class="fas fa-save mr-2"></i>Save Product
                    </button>
                    <button type="button" onclick="closeModal('product-modal')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const backendBaseUrl = window.APP_CONFIG.BACKEND_URL;
        let currentUserId = null;
        let allOrders = [];
        let currentImageData = null;

        // Check authentication on page load
        window.addEventListener('DOMContentLoaded', () => {
            currentUserId = localStorage.getItem('userId');
            if (!currentUserId) {
                alert('Please login first!');
                window.location.href = 'login.html';
                return;
            }

            // Verify admin role
            fetch(`${backendBaseUrl}/user_role/${currentUserId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success || data.role !== 'admin') {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'index.html';
                        return;
                    }
                    // Load admin name
                    return fetch(`${backendBaseUrl}/profile/${currentUserId}`);
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('admin-name').textContent = data.user.name;
                    }
                    // Load dashboard data
                    loadDashboard();
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    alert('Authentication failed. Please login again.');
                    window.location.href = 'login.html';
                });
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.dataset.section;
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('bg-gray-800', 'text-white', 'active'));
                item.classList.add('bg-gray-800', 'text-white', 'active');
                
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
                
                // Show selected section
                document.getElementById(`${section}-section`).classList.remove('hidden');
                
                // Update header
                const titles = {
                    dashboard: 'Dashboard',
                    orders: 'Orders Management',
                    products: 'Products Management',
                    customers: 'Customer Management'
                };
                const subtitles = {
                    dashboard: "Welcome back! Here's what's happening today.",
                    orders: 'Manage and track all customer orders',
                    products: 'Add, edit, and manage your product inventory',
                    customers: 'View customer information and statistics'
                };
                document.getElementById('section-title').textContent = titles[section];
                document.getElementById('section-subtitle').textContent = subtitles[section];
                
                // Load section data
                if (section === 'orders') loadOrders();
                if (section === 'products') loadProducts();
                if (section === 'customers') loadCustomers();
            });
        });

        // Load Dashboard
        function loadDashboard() {
            fetch(`${backendBaseUrl}/admin/dashboard/stats`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('stat-sales').textContent = stats.todays_sales.toFixed(0);
                    document.getElementById('stat-orders-today').textContent = stats.todays_orders;
                    document.getElementById('stat-pending').textContent = stats.pending_orders;
                    document.getElementById('stat-products').textContent = stats.total_products;
                    document.getElementById('stat-low-stock').textContent = stats.low_stock_products;
                    document.getElementById('stat-customers').textContent = stats.total_customers;
                    
                    // Display recent orders
                    const tbody = document.getElementById('recent-orders-tbody');
                    if (stats.recent_orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400">No orders yet</td></tr>';
                    } else {
                        tbody.innerHTML = stats.recent_orders.map(order => `
                            <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="viewOrderDetails('${order._id}')">
                                <td class="py-3 px-4 font-mono text-sm">#${order._id.slice(-6)}</td>
                                <td class="py-3 px-4">${order.customer_info.name}</td>
                                <td class="py-3 px-4">â‚¹${order.total_amount}</td>
                                <td class="py-3 px-4"><span class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')}">${order.status}</span></td>
                                <td class="py-3 px-4 text-sm text-gray-600">${new Date(order.order_date).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    }
                }
            })
            .catch(error => console.error('Error loading dashboard:', error));
        }

        // Load Orders
        function loadOrders() {
            fetch(`${backendBaseUrl}/admin/orders`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allOrders = data.orders;
                    displayOrders(allOrders);
                }
            })
            .catch(error => console.error('Error loading orders:', error));
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('orders-tbody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-mono text-sm">#${order._id.slice(-6)}</td>
                    <td class="py-3 px-4">${order.customer_info.name}</td>
                    <td class="py-3 px-4">${order.customer_info.phone}</td>
                    <td class="py-3 px-4">â‚¹${order.total_amount}</td>
                    <td class="py-3 px-4">
                        <select onchange="updateOrderStatus('${order._id}', this.value)" class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')} border-none cursor-pointer">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(order.order_date).toLocaleString()}</td>
                    <td class="py-3 px-4 text-center">
                        <button onclick="viewOrderDetails('${order._id}')" class="text-purple-600 hover:text-purple-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter orders
        document.getElementById('order-status-filter').addEventListener('change', filterOrders);
        document.getElementById('order-search').addEventListener('input', filterOrders);

        function filterOrders() {
            const statusFilter = document.getElementById('order-status-filter').value;
            const searchQuery = document.getElementById('order-search').value.toLowerCase();
            
            let filtered = allOrders;
            
            if (statusFilter) {
                filtered = filtered.filter(order => order.status === statusFilter);
            }
            
            if (searchQuery) {
                filtered = filtered.filter(order => 
                    order.customer_info.name.toLowerCase().includes(searchQuery) ||
                    order.customer_info.phone.includes(searchQuery)
                );
            }
            
            displayOrders(filtered);
        }

        // Update order status
        function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Change order status to "${newStatus}"?`)) {
                loadOrders(); // Reload to reset select
                return;
            }

            fetch(`${backendBaseUrl}/admin/orders/update-status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify({ order_id: orderId, status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order status updated successfully!');
                    loadOrders();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                    loadOrders();
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                alert('Failed to update order status');
                loadOrders();
            });
        }

        // View order details
        function viewOrderDetails(orderId) {
            fetch(`${backendBaseUrl}/order/${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const order = data.order;
                    const itemsHTML = order.items.map(item => `
                        <tr class="border-b">
                            <td class="py-2">${item.name}</td>
                            <td class="py-2 text-center">${item.quantity}</td>
                            <td class="py-2 text-right">â‚¹${item.price}</td>
                            <td class="py-2 text-right font-medium">â‚¹${item.price * item.quantity}</td>
                        </tr>
                    `).join('');

                    document.getElementById('order-details-content').innerHTML = `
                        <div class="mb-4">
                            <p class="text-gray-600">Order ID</p>
                            <p class="text-lg font-mono font-bold">#${order._id}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600">Customer Details</p>
                            <p class="font-medium">${order.customer_info.name}</p>
                            <p class="text-sm text-gray-600">${order.customer_info.phone}</p>
                            <p class="text-sm text-gray-600">${order.customer_info.address}</p>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600 mb-2">Order Items</p>
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-2 text-left">Product</th>
                                        <th class="py-2 text-center">Qty</th>
                                        <th class="py-2 text-right">Price</th>
                                        <th class="py-2 text-right">Total</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsHTML}</tbody>
                                <tfoot class="border-t-2">
                                    <tr>
                                        <td colspan="3" class="py-2 text-right font-medium">Subtotal:</td>
                                        <td class="py-2 text-right">â‚¹${order.subtotal || 0}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="py-2 text-right font-medium">Delivery Fee:</td>
                                        <td class="py-2 text-right">â‚¹${order.delivery_fee || 0}</td>
                                    </tr>
                                    <tr class="font-bold text-lg">
                                        <td colspan="3" class="py-2 text-right">Total Amount:</td>
                                        <td class="py-2 text-right text-purple-600">â‚¹${order.total_amount}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="mb-4">
                            <p class="text-gray-600">Status</p>
                            <p class="text-lg"><span class="status-badge status-${order.status.toLowerCase().replace(/ /g, '-')}">${order.status}</span></p>
                        </div>
                        <div>
                            <p class="text-gray-600">Order Date</p>
                            <p class="text-sm">${new Date(order.order_date).toLocaleString()}</p>
                        </div>
                    `;
                    document.getElementById('order-modal').classList.add('active');
                }
            })
            .catch(error => console.error('Error loading order details:', error));
        }

        // Load Products
        function loadProducts() {
            fetch(`${backendBaseUrl}/admin/products`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayProducts(data.products);
                }
            })
            .catch(error => console.error('Error loading products:', error));
        }

        function displayProducts(products) {
            const grid = document.getElementById('products-grid');
            if (products.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-400">No products found</div>';
                return;
            }
            
            grid.innerHTML = products.map(product => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition">
                    <img src="${product.image || 'https://via.placeholder.com/300x300?text=No+Image'}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h4 class="font-bold text-lg mb-2 truncate">${product.name}</h4>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-2xl font-bold text-purple-600">â‚¹${product.price}</span>
                            <span class="text-sm ${product.stock < 10 ? 'text-red-600' : 'text-green-600'}">${product.stock || 0} in stock</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3 capitalize">${product.category}</p>
                        <div class="flex gap-2">
                            <button onclick="editProduct('${product._id}')" class="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteProduct('${product._id}')" class="flex-1 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition text-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show add product modal
        function showAddProductModal() {
            document.getElementById('product-modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('cloudinary-public-id').value = '';
            currentImageData = null;
            document.getElementById('dropzone-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('product-modal').classList.add('active');
        }

        // Edit product
        function editProduct(productId) {
            fetch(`${backendBaseUrl}/admin/products`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const product = data.products.find(p => p._id === productId);
                    if (product) {
                        document.getElementById('product-modal-title').textContent = 'Edit Product';
                        document.getElementById('product-id').value = product._id;
                        document.getElementById('product-name').value = product.name;
                        document.getElementById('product-price').value = product.price;
                        document.getElementById('product-stock').value = product.stock || 0;
                        document.getElementById('product-category').value = product.category;
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('cloudinary-public-id').value = product.cloudinary_public_id || '';
                        
                        if (product.image) {
                            document.getElementById('dropzone-content').classList.add('hidden');
                            document.getElementById('image-preview').classList.remove('hidden');
                            document.getElementById('preview-img').src = product.image;
                            currentImageData = product.image;
                        }
                        
                        document.getElementById('product-modal').classList.add('active');
                    }
                }
            })
            .catch(error => console.error('Error loading product:', error));
        }

        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('dropzone-content').classList.add('hidden');
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('preview-img').src = currentImageData;
            };
            reader.readAsDataURL(file);
        }

        // Remove image
        function removeImage(event) {
            event.stopPropagation();
            currentImageData = null;
            document.getElementById('cloudinary-public-id').value = '';
            document.getElementById('dropzone-content').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-input').value = '';
        }

        // Drag and drop handlers
        const dropzone = document.getElementById('image-dropzone');
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('drag-over');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const input = document.getElementById('image-input');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input.files = dataTransfer.files;
                handleImageSelect({ target: input });
            }
        });

        // Save product
        async function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const isEdit = !!productId;
            
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                category: document.getElementById('product-category').value,
                description: document.getElementById('product-description').value,
                cloudinary_public_id: document.getElementById('cloudinary-public-id').value
            };
            
            // Upload new image to Cloudinary if image was changed
            if (currentImageData && currentImageData.startsWith('data:image')) {
                try {
                    const uploadResponse = await fetch(`${backendBaseUrl}/admin/upload-image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'User-ID': currentUserId
                        },
                        body: JSON.stringify({ image_data: currentImageData })
                    });
                    
                    const uploadData = await uploadResponse.json();
                    if (uploadData.success) {
                        productData.image = uploadData.url;
                        productData.cloudinary_public_id = uploadData.public_id;
                    } else {
                        alert('Error uploading image: ' + uploadData.message);
                        return;
                    }
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Failed to upload image');
                    return;
                }
            } else if (currentImageData) {
                productData.image = currentImageData;
            }
            
            // Save product
            const url = isEdit 
                ? `${backendBaseUrl}/admin/products/update/${productId}`
                : `${backendBaseUrl}/admin/products/add`;
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'User-ID': currentUserId
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(isEdit ? 'Product updated successfully!' : 'Product added successfully!');
                    closeModal('product-modal');
                    loadProducts();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving product:', error);
                alert('Failed to save product');
            });
        }

        // Delete product
        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            fetch(`${backendBaseUrl}/admin/products/delete/${productId}`, {
                method: 'DELETE',
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Product deleted successfully!');
                    loadProducts();
                    loadDashboard();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                alert('Failed to delete product');
            });
        }

        // Load Customers
        function loadCustomers() {
            fetch(`${backendBaseUrl}/admin/customers/stats`, {
                headers: { 'User-ID': currentUserId }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayCustomers(data.customers);
                }
            })
            .catch(error => console.error('Error loading customers:', error));
        }

        function displayCustomers(customers) {
            const tbody = document.getElementById('customers-tbody');
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No customers found</td></tr>';
                return;
            }
            
            tbody.innerHTML = customers.map(customer => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4 font-medium">${customer.name}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${customer.email || 'N/A'}</td>
                    <td class="py-3 px-4">${customer.phone}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${customer.order_count}</span>
                    </td>
                    <td class="py-3 px-4 text-right font-bold text-green-600">â‚¹${customer.total_spent.toFixed(2)}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${customer.created_at ? new Date(customer.created_at).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('userId');
                window.location.href = 'login.html';
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };
    </script>
</body>
</html>
